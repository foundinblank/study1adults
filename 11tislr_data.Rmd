---
title: "TISLR Data Analysis"
author: "Adam Stone, PhD"
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r}
get_xy_timestamp <- function(z){

x <- read_lines(z) %>%
  as_tibble() %>%
  rowid_to_column("ID")

# pull out timestamp rows
timestamps <- x %>%
  filter(str_detect(value, "timestamp")) %>%
  separate(value, into = c("throw","timestamp"), sep = " = ") %>%
  separate(timestamp, into = c("one","two","sec"), sep = ":") %>%
  select(sec) %>%
  mutate(sec = as.numeric(sec))

# Find AOI coordinate rows
xys <- x %>%
  mutate(find = str_detect(value, "X\tY"))

# first vertex (2 rows after each "XY" line)
xys_row <- which(xys$find) + 2

xy1 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x1","y1"), sep = "\t") %>%
  select(-ID)

# opposite vertex (2 more rows down)
xys_row <- xys_row + 2

xy2 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x2","y2"), sep = "\t") %>%
  select(-ID)

# Now get average XY position per timestamp
xys <- cbind(timestamps, xy1, xy2) %>%
  mutate_all(as.numeric) %>%
  rowwise() %>%
  mutate(x = mean(x1,x2),
         y = mean(y1, y2)) %>%
  select(sec, x, y)
}
```

# Three Bears Data

## Introduction

Rain, I was confused by the low number of participants in each group...then realized only half the participants saw Three Bears Forward, right? The other half saw Three Bears Backwards? 
```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)
library(janitor)
library(skimr)
library(gganimate)
library(tsibble)

# Get Three Bears data
rawdata <- read.xlsx("Test1_Cindy_bears_FW_Examine for Spatial Referencing.xlsx") %>%
  clean_names() %>%
  rename(x = gaze_point_x_mc_spx,
         y = gaze_point_y_mc_spx,
         language = language_value,
         name = participant_name,
         group = group_value)

# Pull clean names (and handle Laura2 for Laura (missing stories))
cleannames <- read_csv("partnames.csv") %>%
  distinct() %>%
  rename(name = participant) %>%
  filter(name != "Laura2")

# Pull final group assignments
cleangroups <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup) %>%
  rename(name = participant) %>%
  distinct()

# Join both to rawdata
data <- rawdata %>%
  left_join(cleannames, by = "name") %>%
  select(-name) %>%
  rename(name = new_participant) %>%
  filter(!is.na(name)) %>%
  left_join(cleangroups, by = "name") %>%
  select(-group)

# Let's find out who was NOT included in Three Bears
excluded <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup, story, direction, eye_exclude) %>%
  filter(story == "Goldilocks" & direction == "forward") %>%
  rename(name = participant) %>%
  select(name, eye_exclude)

data <- data %>% left_join(excluded, by = "name") %>%
  filter(!eye_exclude) %>%
  filter(!is.na(eye_exclude)) %>%
  select(-c(eye_exclude, recording_name)) %>%
  mutate_at(vars(language, maingroup, name), as.factor)

data %>% distinct(name, maingroup) %>% count(maingroup)

skim(data)
```

Let's graph everything, first of all. 

```{r warning=FALSE}
data %>%
  ggplot(aes(x = gaze_point_index, y = y, color = maingroup, group = name)) + 
  geom_line() + 
  scale_y_reverse(limits = c(1200,0)) +
  theme_bw() +
  facet_wrap("name")
```

## Smoothing

We're adding smoothing with two different moving average window sizes - 5 and 10. (y_ma5, y_ma10). Good for removing noise. We'll try using either and see where we go. 

> The data were then smoothed with a standard moving average noise reduction algorithm (window size = 5 samples) which acts as a low-pass filter that reduces the influence of microsaccades, blinks, and large data gaps (based on Yarbus, 1967). 

```{r}
data <- data %>%
  as_tsibble(key = id(name), index = gaze_point_index) %>%
  group_by(maingroup, name) %>%
  mutate(y_ma5 = slide_dbl(y, ~ mean(., na.rm = T), .size = 5)) %>%
  mutate(y_ma10 = slide_dbl(y, ~ mean(., na.rm = T), .size = 10)) %>%
  as_tibble() %>%
  ungroup()

# data %>%
#   ggplot(aes(x = gaze_point_index, y = y_ma5, color = maingroup, group = name)) +
#   geom_line() + 
#   scale_y_reverse(limits = c(1200,0)) +
#   theme_bw() +
#   facet_wrap("name")
# 
# data %>%
#   ggplot(aes(x = gaze_point_index, y = y_ma10, color = maingroup, group = name)) +
#   geom_line() + 
#   scale_y_reverse(limits = c(1200,0)) +
#   theme_bw() +
#   facet_wrap("name")

data %>%
  filter(name == "Adam") %>%
  ungroup() %>%
  gather(key = "metric", value = "y_position", c(y, y_ma5, y_ma10)) %>%
  ggplot(aes(x = gaze_point_index, y = y_position, color = metric)) +
  geom_line() +
  facet_wrap("metric", nrow = 3) +
  scale_y_reverse(limits = c(1200,0)) +
  ggtitle("Adam")


data %>%
  filter(name == "JJ") %>%
  ungroup() %>%
  gather(key = "metric", value = "y_position", c(y, y_ma5, y_ma10)) %>%
  ggplot(aes(x = gaze_point_index, y = y_position, color = metric)) +
  geom_line() +
  facet_wrap("metric", nrow = 3) +
  scale_y_reverse(limits = c(1200,0)) +
  ggtitle("JJ")
```

Also curious about missing data points. 

```{r}
data %>%
  group_by(name) %>%
  summarise_at(vars(y, y_ma5, y_ma10), funs(sum(is.na(.))))
```

## Playing with animation 

Let's use group averages of y_ma10. 

```{r}
average_ma10 <- data %>%
  group_by(maingroup, gaze_point_index) %>%
  summarise(x = mean(x, na.rm = T),
            y = mean(y_ma10, na.rm = T)) %>%
  filter(!is.na(y))
  

p <- ggplot(average_ma10, aes(x = x, y = y, color = maingroup, group = maingroup)) +
  geom_point() +
  scale_x_continuous(limits = c(0,1600)) +
  scale_y_reverse(limits = c(1200,0))

p

anim <- p + 
  transition_time(gaze_point_index) +
  ggtitle("Gaze Point Index: {round(frame_time,0)}", subtitle = 'Frame {frame} of {nframes}') +
  shadow_wake(wake_length = 0.1, alpha = 0.25)
  
#animate(anim, duration = 25.8)
```


