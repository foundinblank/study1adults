---
title: "CRQA Analysis"
author: "Adam Stone, PhD"
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r}
get_xy_timestamp <- function(z){

x <- read_lines(z) %>%
  as_tibble() %>%
  rowid_to_column("ID")

# pull out timestamp rows
timestamps <- x %>%
  filter(str_detect(value, "timestamp")) %>%
  separate(value, into = c("throw","timestamp"), sep = " = ") %>%
  separate(timestamp, into = c("one","two","sec"), sep = ":") %>%
  select(sec) %>%
  mutate(sec = as.numeric(sec))

# Find AOI coordinate rows
xys <- x %>%
  mutate(find = str_detect(value, "X\tY"))

# first vertex (2 rows after each "XY" line)
xys_row <- which(xys$find) + 2

xy1 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x1","y1"), sep = "\t") %>%
  select(-ID)

# opposite vertex (2 more rows down)
xys_row <- xys_row + 2

xy2 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x2","y2"), sep = "\t") %>%
  select(-ID)

# Now get average XY position per timestamp
xys <- cbind(timestamps, xy1, xy2) %>%
  mutate_all(as.numeric) %>%
  rowwise() %>%
  mutate(x = mean(x1,x2),
         y = mean(y1, y2)) %>%
  select(sec, x, y)
}
```

# Three Bears Data


Setting up the dataset:

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)
library(janitor)
library(skimr)
library(gganimate)
library(tsibble)

# Get Three Bears data
rawdata <- read.xlsx("Test1_Cindy_bears_FW_Examine for Spatial Referencing.xlsx") %>%
  clean_names() %>%
  rename(x = gaze_point_x_mc_spx,
         y = gaze_point_y_mc_spx,
         language = language_value,
         name = participant_name,
         group = group_value)

# Pull clean names (and handle Laura2 for Laura (missing stories))
cleannames <- read_csv("partnames.csv") %>%
  distinct() %>%
  rename(name = participant) %>%
  filter(name != "Laura2")

# Pull final group assignments
cleangroups <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup) %>%
  rename(name = participant) %>%
  distinct()

# Join both to rawdata
data <- rawdata %>%
  left_join(cleannames, by = "name") %>%
  select(-name) %>%
  rename(name = new_participant) %>%
  filter(!is.na(name)) %>%
  left_join(cleangroups, by = "name") %>%
  select(-group)

# Let's find out who was NOT included in Three Bears
excluded <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup, story, direction, eye_exclude) %>%
  filter(story == "Goldilocks" & direction == "forward") %>%
  rename(name = participant) %>%
  select(name, eye_exclude)

data <- data %>% left_join(excluded, by = "name") %>%
  filter(!eye_exclude) %>%
  filter(!is.na(eye_exclude)) %>%
  select(-c(eye_exclude, recording_name)) %>%
  mutate_at(vars(language, maingroup, name), as.factor)

data %>% distinct(name, maingroup) %>% count(maingroup)

skim(data)
```

Let's graph everything, first of all. 

```{r warning=FALSE}
data %>%
  ggplot(aes(x = gaze_point_index, y = y, color = maingroup, group = name)) + 
  geom_line() + 
  scale_y_reverse(limits = c(1080,0)) +
  theme_bw() +
  facet_wrap("name")
```

# Smoothing

We're adding smoothing with a moving average window size - 5. (y_ma5). Good for removing noise.

Then we'll eliminate 30 samples from the start and end (that's 0.25 seconds on both sides). 

> The data were then smoothed with a standard moving average noise reduction algorithm (window size = 5 samples) which acts as a low-pass filter that reduces the influence of microsaccades, blinks, and large data gaps (based on Yarbus, 1967). 

```{r}

min_gaze_point_index <- data %>% 
  group_by(maingroup) %>%
  summarise(max = max(gaze_point_index)) %>%
  ungroup() %>%
  summarise(min(max)) %>%
  pull()

bookend <- 30

data_ma <- data %>%
  as_tsibble(key = id(name), index = gaze_point_index) %>%
  group_by(maingroup, name) %>%
  mutate(y_ma5 = slide_dbl(y, ~ mean(., na.rm = T), .size = 5)) %>%
  mutate(y_ma5 = na_if(y_ma5, 'NaN')) %>%
  as_tibble() %>%
  ungroup() %>%
  filter(gaze_point_index > bookend & gaze_point_index < min_gaze_point_index - bookend)

# data_ma %>%
#   ggplot(aes(x = gaze_point_index, y = y_ma5, color = maingroup, group = name)) +
#   geom_line() + 
#   scale_y_reverse(limits = c(1200,0)) +
#   theme_bw() +
#   facet_wrap("name")
# 
# data_ma %>%
#   ggplot(aes(x = gaze_point_index, y = y_ma10, color = maingroup, group = name)) +
#   geom_line() + 
#   scale_y_reverse(limits = c(1200,0)) +
#   theme_bw() +
#   facet_wrap("name")

data_ma %>%
  filter(name == "Erin") %>%
  ungroup() %>%
  gather(key = "metric", value = "y_position", c(y, y_ma5)) %>%
  ggplot(aes(x = gaze_point_index, y = y_position, color = metric)) +
  geom_line() +
  facet_wrap("metric", nrow = 3) +
  scale_y_reverse(limits = c(1080,0)) +
  ggtitle("Erin")


data_ma %>%
  filter(name == "Monica") %>%
  ungroup() %>%
  gather(key = "metric", value = "y_position", c(y, y_ma5)) %>%
  ggplot(aes(x = gaze_point_index, y = y_position, color = metric)) +
  geom_line() +
  facet_wrap("metric", nrow = 3) +
  scale_y_reverse(limits = c(1080,0)) +
  ggtitle("Monica")
```

Also curious about missing data points. This counts how many missing data points we have for each participant, at the three different measurements. Based on that, I probably should take out Lynnette, so much missing data there. We'll worry about that later. 

```{r}
data_ma %>%
  group_by(name, maingroup) %>%
  summarise_at(vars(y, y_ma5), list(~sum(is.na(.)))) %>%
  ungroup() %>%
  arrange(desc(y))

data_ma %>%
  group_by(maingroup) %>%
  summarise_at(vars(y, y_ma5), list(~sum(is.na(.)))) %>%
  ungroup() %>%
  arrange(desc(y))
```

# CRQA: Comparing Erin & Monica

Both Erin and Monica have no missing data. Let's go with them (their graphs are above). 

```{r message=FALSE, warning=FALSE}
library(crqa)

erin <- filter(data_ma, name == "Erin") %>%
  pull(y)
erin_ma5 <- filter(data_ma, name == "Erin") %>%
  pull(y_ma5)
monica <- filter(data_ma, name == "Monica") %>%
  pull(y)
monica_ma5 <- filter(data_ma, name == "Monica") %>%
  pull(y_ma5)

results <- crqa(erin, monica, delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')

dcrp <- drpdfromts(erin_ma5, monica_ma5, ws = 60, datatype = 'continuous', radius = 0.05)
plot(-60:60, dcrp$profile, type = 'l', xlab = "Lag", ylab = "%Rec")
```

# CRQA: 

## Comparing Monica & Right Hand

```{r}

# Prepare rhand, lhand, and mouth data: 
rows_to_use <- data_ma %>% filter(name == "Adam") %>% nrow()

rhand <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of Right Hand.txt") %>%
  mutate(sec = floor(sec*120)) %>%
  mutate(sec = sec + 1) %>%
  add_row(sec = rows_to_use) %>%
  fill(x, y)
rhand_expanded <- seq(1, max(rhand$sec)) %>%
  enframe(name = NULL, value = 'sec') %>%
  left_join(rhand, by = 'sec') %>%
  fill(x, y)
rhand_y <- rhand_expanded %>% pull(y)

lhand <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of Left Hand.txt") %>%
  mutate(sec = floor(sec*120)) %>%
  mutate(sec = sec + 1) %>%
  add_row(sec = rows_to_use) %>%
  fill(x, y)
lhand_expanded <- seq(1, max(lhand$sec)) %>%
  enframe(name = NULL, value = 'sec') %>%
  left_join(lhand, by = 'sec') %>%
  fill(x, y)
lhand_y <- lhand_expanded %>% pull(y)

mouth <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of mouth small.txt") %>%
  mutate(sec = floor(sec*120)) %>%
  mutate(sec = sec + 1) %>%
  add_row(sec = rows_to_use) %>%
  fill(x, y)
mouth_expanded <- seq(1, max(mouth$sec)) %>%
  enframe(name = NULL, value = 'sec') %>%
  left_join(mouth, by = 'sec') %>%
  fill(x, y)
mouth_y <- mouth_expanded %>% pull(y)


# Compare Monica to RHand
results <- crqa(monica_ma5, rhand_y, delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
results$RR

# Shuffle to get baseline measure of cross-recurrences
results_shuffled <- crqa(sample(monica_ma5), sample(rhand_y), delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
results_shuffled$RR
```

## CRQA for all participants

To make this work, we have to fill in all missing values - CRQA doesn't like them. So umm, let's just, for now, do a fill-in where any NA takes the most recent valid value preceding it. 

```{r}
# Functions for running CRQA on the right hand
crqa_rhand <- function(x){
  crqa_results <- crqa(x, rhand_y, delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
  crqa_results$RR
}

crqa_rhand_shuffled <- function(x){
  crqa_results <- crqa(sample(x), sample(rhand_y), delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
  crqa_results$RR
}

crqa_mouth <- function(x){
  crqa_results <- crqa(x, mouth_y, delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
  crqa_results$RR
}

crqa_mouth_shuffled <- function(x){
  crqa_results <- crqa(sample(x), sample(mouth_y), delay = 9, embed = 3, rescale = 2, radius = 20, normalize = 2, mindiagline = 2, minvertline = 2, tw = 0, whiteline = FALSE, recpt = FALSE, side = 'both')
  crqa_results$RR
}


library(furrr)
plan(multiprocess)
data_nested <- data_ma %>%
  fill(y_ma5) %>%
  group_by(name) %>%
  nest(y_ma5) %>%
  mutate(RR_rhand = future_map_dbl(data, crqa_rhand),
         RR_rhand_shuffled = future_map_dbl(data, crqa_rhand_shuffled),
         RR_mouth = future_map_dbl(data, crqa_mouth),
         RR_mouth_shuffled = future_map_dbl(data, crqa_mouth_shuffled))

data_nested_results <- data_nested %>%
  select(-data) %>%
  left_join(data, by = "name") %>%
  select(name, maingroup, RR_rhand, RR_rhand_shuffled, RR_mouth, RR_mouth_shuffled) %>%
  distinct() 

#data_nested_results

data_nested_results_group <- data_nested_results %>%
  group_by(maingroup) %>%
  mutate(participants = n()) %>%
  group_by(maingroup, participants) %>%
  summarise_if(is.double, funs(mean))

data_nested_results_group

data_nested_results %>%
  ggplot(aes(x = maingroup, y = RR_rhand, fill = maingroup)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.5) +
  guides(fill = F) +
  labs(x = "",
       y = "Percent Recurrence (%REC)",
       title = "Recurrence with position of right hand")

data_nested_results %>%
  ggplot(aes(x = maingroup, y = RR_mouth, fill = maingroup)) +
  geom_boxplot() +
  geom_jitter(width = 0.1, alpha = 0.5) +
  guides(fill = F) +
  labs(x = "",
       y = "Percent Recurrence (%REC)",
       title = "Recurrence with position of mouth")


# data_nested_results %>%
#   ggplot(aes(x = maingroup, y = diff)) +
#   geom_boxplot()
```


# DCRP
```{r}
dcrp <- drpdfromts(erin_ma5, rhand_y, ws = 60, datatype = 'continuous', radius = 0.5)
plot(-60:60, dcrp$profile, type = 'l', xlab = "Lag", ylab = "%Rec")
```

