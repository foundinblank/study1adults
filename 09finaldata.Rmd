---
title: "The Last Data Analysis to Rule Them All? (study1adults)"
author: "Adam Stone, PhD"
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: paper
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Putting It All Back Together

Throughout all the data analysis we've done, the datasets have become more fragmented - lexical recall, gist, and eye tracking datasets. I want to put them all together in one whole dataset again so we can perform some analyses more efficiently (particularly correlations). The only thing I need to remember is we'll have a new column called `eye_exclude` and if it is set to `TRUE` it means we can't include that row in any analysis relating to eye gaze (usually because that trial was less than 25% looking). 

```{r smash data together, message=FALSE, warning=FALSE}
# Libraries
library(tidyverse)
library(lme4)
library(lmerTest)
library(scales)
library(viridis)
library(agricolae) 
library(GGally)
library(ez)

# Load lex and eye data
cleanlexdata <- read_csv("cleandata.csv") %>%
  select(-(forehead:total))

cleaneyedata <- read_csv("cleanpercentdata.csv") %>%
  spread(aoi,percent) %>%
  add_column(eye_exclude = FALSE)

# What rows were removed from the eye data back in 03eyegaze? Let's add back in
# With a new column - eye_exclude
removed <- anti_join(cleanlexdata, cleaneyedata) %>%
  add_column(eye_exclude = TRUE)
eyelexdata <- bind_rows(cleaneyedata, removed)

# Load gist data
gist <- read_csv('gist_indiv.csv', col_types = cols(
  participant = col_character(),
  gist.fw1 = col_integer(),
  gist.rv2 = col_integer(),
  gist.fw3 = col_integer(),
  gist.rv4 = col_integer()
)) %>%
  gather(video, gist, gist.fw1:gist.rv4) %>%
  mutate(video = str_sub(video,6,8))

# Presto, our full reunified dataset - 'fulldata'
# But I want to remove columns I don't want anymore and will recalculate later
fulldata <- left_join(eyelexdata, gist) %>%
  select(-moutheye, -facechest, -face, -chest)
```

# Group Changes and Participant Tables

We have some changes to make to the groups. First, fix Josh as learning ASL when he was 6. Next, drop the DeafNative Group and reclassify all who learned ASL < 3.9 as DeafEarly and ASL => 4.0 as DeafLate. 

```{r groups and participant tables}
# Change Josh's AoASL to 6
fulldata <- fulldata %>%
  mutate(aoasl = as.double(aoasl)) %>%
  mutate(aoasl = case_when(
    participant == "Josh" ~ 6,
    TRUE ~ aoasl
  ))

# Reclassify Groups
fulldata <- fulldata %>%
  mutate(maingroup = case_when(
    hearing == "Deaf" & aoasl < 4 ~ "DeafEarly",
    hearing == "Deaf" & aoasl >= 4 ~ "DeafLate",
    maingroup == "HearingLateASL" ~ "HearingLate",
    maingroup == "HearingNoviceASL" ~ "HearingNovice"
  ))

# Create Participant Demographics Table
participant_info <- fulldata %>%
  select(-(acc:gist)) %>%
  select(-(video:direction)) %>%
  distinct() %>% 
  group_by(maingroup) %>%
  summarise(n = n(),
            age_mean = mean(age),
            age_sd = sd(age),
            aoasl_mean = mean(aoasl),
            aoasl_sd = sd(aoasl),
            signyrs_mean = mean(signyrs),
            signyrs_sd = sd(signyrs),
            selfrate_mean = mean(selfrate),
            selfrate_sd = sd(selfrate)) %>%
  ungroup() %>%
  mutate_if(is.double, funs(round(., 2))) %>%
  mutate(age = paste(age_mean, "±", age_sd, sep = " "),
         aoasl = paste(aoasl_mean, "±", aoasl_sd, sep = " "),
         signyrs = paste(signyrs_mean, "±", signyrs_sd, sep = " "),
         selfrate = paste(selfrate_mean, "±", selfrate_sd, sep = " ")) %>%
  select(-(age_mean:selfrate_sd))

participant_info
write_csv(fulldata, "finaldataset.csv")

data_lowaoi <- fulldata %>% select(participant, story, belly:upperchest) %>% select(-eyes, -mouth, -chin) %>% gather(aoi, percent, belly:upperchest)
data_lowaoi$percent[is.na(data_lowaoi$percent)] <- 0
mean(data_lowaoi$percent, na.rm=TRUE)
sd(data_lowaoi$percent, na.rm=TRUE)
```
## Participant ANOVAs 

Below are the ANOVA outputs for participant demographics, and LSDs for each. 

Participants' age
```{r subject anova age, echo=FALSE, warning=FALSE}
# Make the participant data frame
p_anovas <- fulldata %>%
  select(-(acc:gist)) %>%
  select(-(video:direction)) %>%
  distinct() %>%
  select(maingroup:aoasl)

# Age ANOVA
p_age <- aov(age ~ maingroup, data = p_anovas)
summary(p_age)
p_age_lsd <- LSD.test(p_age, "maingroup", group = FALSE)$comparison
p_age_lsd
```


Participants' AoASL
```{r subject anova aoasl, echo=FALSE, warning=FALSE}
# AoASL ANOVA
p_aoasl <- aov(aoasl ~ maingroup, data = p_anovas)
summary(p_aoasl)
p_aoasl_lsd <- LSD.test(p_aoasl, "maingroup", group = FALSE)$comparison
p_aoasl_lsd
```

Participants' Sign Yrs
```{r subject anova signyrs, echo=FALSE, warning=FALSE}
# Signyrs ANOVA
p_signyrs <- aov(signyrs ~ maingroup, data = p_anovas)
summary(p_signyrs)
p_signyrs_lsd <- LSD.test(p_signyrs, "maingroup", group = FALSE)$comparison
p_signyrs_lsd
```

Participants' Self-Rating
```{r subject anova selfrate, echo=FALSE, warning=FALSE}
# Selfrate ANOVA
p_selfrate <- aov(selfrate ~ maingroup, data = p_anovas)
summary(p_selfrate)
p_selfrate_lsd <- LSD.test(p_selfrate, "maingroup", group = FALSE)$comparison
p_selfrate_lsd
```

# Gist & Lexical Recall Data

## Tables & Charts

Let's generate a table for lexical recall and gist for forward vs. reversed stories. 

```{r lex & gist table}
lexgist_info <- fulldata %>%
  group_by(maingroup, direction) %>%
  summarise(lex_mean = mean(acc, na.rm = TRUE),
            lex_sd = sd(acc, na.rm = TRUE),
            gist_mean = mean(gist),
            gist_sd = sd(gist)) %>%
  ungroup() %>%
  mutate_if(is.double, funs(round(., 2))) %>% 
  mutate(lex = paste(lex_mean, "±", lex_sd, sep = " "),
         gist = paste(gist_mean, "±", gist_sd, sep = " ")) %>%
  select(-(lex_mean:gist_sd)) %>%
  gather(metric, value, lex:gist) %>%
  unite("metric", c(metric, direction), sep = "_") %>%
  spread(metric, value) %>%
  print()
```

And then bar charts too after that with error bars. 

```{r lex and gist bar charts}
# Gist bar chart
gist_bar <- fulldata %>% select(participant, maingroup, direction, gist) %>%
  group_by(maingroup, participant, direction) %>%
  summarise(gist = mean(gist)) %>%
  group_by(maingroup, direction) %>%
  summarise(mean = mean(gist),
            sd = sd(gist),
            count = n(),
            se = sd/sqrt(count)) %>%
  ungroup() %>%
  mutate(maingroup = case_when(
    maingroup == "DeafEarly" ~ "Deaf Early",
    maingroup == "DeafLate" ~ "Deaf Late",
    maingroup == "HearingLate" ~ "Hearing Late",
    maingroup == "HearingNovice" ~ "Hearing Novice"
    ))

ggplot(gist_bar, aes(x = maingroup, y = mean, fill = direction)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "Gist", x = "", y = "mean gist accuracy") +
  scale_y_continuous(labels = percent, limits = c(0,1)) + theme_bw()

# Lex bar chart
lex_bar <- fulldata %>% select(participant, maingroup, direction, acc) %>%
  group_by(maingroup, participant, direction) %>%
  summarise(acc = mean(acc, na.rm = TRUE)) %>%
  group_by(maingroup, direction) %>%
  summarise(mean = mean(acc, na.rm = TRUE),
            sd = sd(acc, na.rm = TRUE),
            count = n(),
            se = sd/sqrt(count)) %>%
  ungroup() %>%
  mutate(maingroup = case_when(
    maingroup == "DeafEarly" ~ "Deaf Early",
    maingroup == "DeafLate" ~ "Deaf Late",
    maingroup == "HearingLate" ~ "Hearing Late",
    maingroup == "HearingNovice" ~ "Hearing Novice"
    ))

ggplot(lex_bar, aes(x = maingroup, y = mean, fill = direction)) +
  geom_bar(stat = "identity", position = position_dodge()) + 
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "Lexical Recall", x = "", y = "mean lexical recall accuracy") +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  geom_hline(yintercept = .5, linetype = "dotted") +
  coord_cartesian(ylim = c(.5,1)) + theme_bw()
```

And let's calculate the average reduction in score due to reversal first is lex recall, then gist.

```{r}
reversal_lex <- fulldata %>%
  group_by(id, direction) %>%
  summarise(lex_mean = mean(acc, na.rm = TRUE)) %>%
  spread(direction, lex_mean) %>%
  group_by(id) %>%
  mutate(reversal = forward - reversed) %>%
  ungroup()

paste("lex mean", mean(reversal_lex$reversal))
paste("lex sd", sd(reversal_lex$reversal))

reversal_gist <- fulldata %>%
  group_by(id, direction) %>%
  summarise(gist_mean = mean(gist, na.rm = TRUE)) %>%
  spread(direction, gist_mean) %>%
  group_by(id) %>%
  mutate(reversal = forward - reversed) %>%
  ungroup()

paste("gist mean", mean(reversal_gist$reversal))
paste("gist sd", sd(reversal_gist$reversal))


```


## ANOVA Plan
Next, we're going to do ANOVAs. We'll always do it in this order.

1. ANOVA with factors MainGroup & Direction
2. ANOVA with factor MainGroup, for Forward only
3. ANOVA with factor MainGroup, for Reverse only 

(I also ran ANCOVAs before but now have taken them out...they are below: (4) ANCOVA with factor Direction, and covariate AoASL and Age, (5) Regression with variables AoASL and Age, for Forward only, (6) Regression with variables AoASL and Age, for Reverse only.) 

I did not include Age as a covariate in the first 3 ANOVAs because they did not add to or change the model in any significant way. 

## Gist ANOVAs

1. ANOVA with factors MainGroup & Direction.

```{r gist anova1, echo=TRUE, results = 'markup'}
# First let's make the participant-level dataset with which we'll do our ANCOVAs. 
participant_data <- fulldata %>%
  group_by(maingroup, participant, direction) %>%
  mutate(gist = mean(gist, na.rm = TRUE),
         acc = mean(acc, na.rm = TRUE)) %>%
  ungroup() %>%
  select(id, participant, hearing, maingroup, direction, age, aoasl, acc, gist) %>%
  distinct() %>%
  mutate(id = factor(id),
         participant = factor(participant),
         hearing = factor(hearing),
         maingroup = factor(maingroup),
         direction = factor(direction))

# # Gist ANOVA 1
# gist_aov1 <- aov(gist ~ maingroup * direction, data = participant_data)
# summary(gist_aov1)
# gist_lsd1 <- LSD.test(gist_aov1, "maingroup", group = FALSE)
# gist_lsd1$comparison

# Gist EZ ANOVA
ezANOVA(
  data = participant_data,
  dv = gist,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only. *In the code is a Kruskal-Wallis test. And Chi-Sq too.*

```{r gist anova2, echo=TRUE, results= 'markup'}
# # Gist ANOVA 2
# gist_aov2 <- aov(gist ~ maingroup, data = filter(participant_data, direction == "forward"))
# summary(gist_aov2)
# gist_lsd2 <- LSD.test(gist_aov2, "maingroup", group = FALSE)
# gist_lsd2$comparison

ezANOVA(
  data = filter(participant_data, direction == "forward"),
  dv = gist,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]

# # KW Non-parametric test (like one-way ANOVA)
# kruskal.test(gist ~ maingroup, data = as.matrix(filter(participant_data, direction == "forward")))
# 
# # Chi Sq
# gist_chisq_fw <- participant_data %>%
#   ungroup() %>%
#   filter(direction == "forward") %>%
#   select(maingroup, gist) %>%
#   group_by(maingroup, gist) %>%
#   summarise(count = n()) %>%
#   spread(gist, count) %>%
#   rename(none = "0",
#          one = "0.5",
#          both = "1")
# 
# gist_chisq_fw[is.na(gist_chisq_fw)] <- 0L
# gist_chisq_fw <- cbind(gist_chisq_fw[,"none"], gist_chisq_fw[,"one"], gist_chisq_fw[,"both"])
# chisq.test(gist_chisq_fw)
```

3. ANOVA with factor MainGroup, for Reverse only. *In the code is a Kruskal-Wallis test. And Chi-Sq too.*

```{r gist anova3, echo=TRUE, results = 'markup'}
# # Gist ANOVA 3
# gist_aov3 <- aov(gist ~ maingroup, data = filter(participant_data, direction == "reversed"))
# summary(gist_aov3)
# gist_lsd3 <- LSD.test(gist_aov3, "maingroup", group = FALSE)
# gist_lsd3$comparison 

ezANOVA(
  data = filter(participant_data, direction == "reversed"),
  dv = gist,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]

# # KW Non-parametric test (like one-way ANOVA)
# kruskal.test(gist ~ maingroup, data = as.matrix(filter(participant_data, direction == "reversed")))
# 
# # Chi Sq
# gist_chisq_rv <- participant_data %>%
#   ungroup() %>%
#   filter(direction == "reversed") %>%
#   select(maingroup, gist) %>%
#   group_by(maingroup, gist) %>%
#   summarise(count = n()) %>%
#   spread(gist, count) %>%
#   rename(none = "0",
#          one = "0.5",
#          both = "1")
# 
# gist_chisq_rv[is.na(gist_chisq_rv)] <- 0L
# gist_chisq_rv <- cbind(gist_chisq_rv[,"none"], gist_chisq_rv[,"one"], gist_chisq_rv[,"both"])
# chisq.test(gist_chisq_rv)
```

## Lexical Recall ANOVAs

1. ANOVA with factors MainGroup & Direction.

```{r acc anova1, echo=TRUE, results = 'markup'}
# # Lexical Recall ANOVA 1
# acc_aov1 <- aov(acc ~ maingroup * direction, data = participant_data)
# summary(acc_aov1)
# acc_lsd1 <- LSD.test(acc_aov1, "maingroup", group = FALSE)
# acc_lsd1$comparison

ezANOVA(
  data = participant_data,
  dv = acc,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only.

```{r acc anova2, echo=TRUE, results = 'markup'}
# # Lexical Recall ANOVA 2
# acc_aov2 <- aov(acc ~ maingroup, data = filter(participant_data, direction == "forward"))
# summary(acc_aov2)
# acc_lsd2 <- LSD.test(acc_aov2, "maingroup", group = FALSE)
# acc_lsd2$comparison

ezANOVA(
  data = filter(participant_data, direction == "forward"),
  dv = acc,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

3. ANOVA with factor MainGroup, for Reverse only. 

```{r acc anova3, echo=TRUE, results = 'markup'}
# # Lexical Recall ANOVA 3
# acc_aov3 <- aov(acc ~ maingroup, data = filter(participant_data, direction == "reversed"))
# summary(acc_aov3)
# acc_lsd3 <- LSD.test(acc_aov3, "maingroup", group = FALSE)
# acc_lsd3$comparison

ezANOVA(
  data = filter(participant_data, direction == "reversed"),
  dv = acc,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

# AoA Correlations

Next, we want to look at correlations between AoA and Gist, and betwen AoA and Lexical Recall. Rain asked for forward and reversed separately (1) deaf only, (2) hearing only, and (3) both. Let's make it work. 

```{r repackage data for correlations, message=FALSE, warning=FALSE}
# Let's make participant-level data, and have forward/reversed in separate columns
lexgist_data <- fulldata %>%
  group_by(maingroup, participant, direction) %>%
  mutate(gist = mean(gist, na.rm = TRUE),
         lex = mean(acc, na.rm = TRUE)) %>%
  ungroup() %>%
  select(maingroup, participant, hearing, direction, aoasl, signyrs, age, gist, lex) %>%
  distinct() %>%
  gather(metric, value, gist:lex) %>%
  unite(metricvalue, c(metric, direction), sep = "_") %>%
  spread(metricvalue, value) %>%
  select(-participant, -maingroup)

lexgist_deaf <- lexgist_data %>% filter(hearing == "Deaf") %>% select(-hearing)
lexgist_hearing <- lexgist_data %>% filter(hearing == "Hearing") %>% select(-hearing)
lexgist_all <- lexgist_data %>% select(-hearing)

# Load awesome function to make correlation tables with stars for significance
# From: https://myowelt.blogspot.co.uk/2008/04/beautiful-correlation-tables-in-r.html
corstarsl <- function(x){ 
require(Hmisc) 
x <- as.matrix(x) 
R <- Hmisc::rcorr(x)$r 
p <- Hmisc::rcorr(x)$P 
## define notions for significance levels; spacing is important.
mystars <- ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "* ", " ")))
## trunctuate the matrix that holds the correlations to two decimal
R <- format(round(cbind(rep(-1.11, ncol(x)), R), 2))[,-1] 
## build a new matrix that includes the correlations with their apropriate stars 
Rnew <- matrix(paste(R, mystars, sep=""), ncol=ncol(x)) 
diag(Rnew) <- paste(diag(R), " ", sep="") 
rownames(Rnew) <- colnames(x) 
colnames(Rnew) <- paste(colnames(x), "", sep="") 
## remove upper triangle
Rnew <- as.matrix(Rnew)
Rnew[upper.tri(Rnew, diag = TRUE)] <- ""
Rnew <- as.data.frame(Rnew) 
## remove last column and return the matrix (which is now a data frame)
Rnew <- cbind(Rnew[1:length(Rnew)-1])
return(Rnew) 
}

# Correlations for Deaf
print("DEAF Correlations - Pearson's r")
#corstarsl(lexgist_deaf)
Hmisc::rcorr(as.matrix(lexgist_deaf))$r
print("DEAF Correlations - P-values")
Hmisc::rcorr(as.matrix(lexgist_deaf))$P
cat(paste("","\n",""))

# Correlations for Hearing
print("HEARING Correlations - Pearson's r")
#corstarsl(lexgist_hearing)
Hmisc::rcorr(as.matrix(lexgist_hearing))$r
print("HEARING Correlations - P-values")
Hmisc::rcorr(as.matrix(lexgist_hearing))$P
cat(paste("","\n",""))

# Correlations for All
print("ALL Correlations - Pearson's r")
#corstarsl(lexgist_all)
Hmisc::rcorr(as.matrix(lexgist_all))$r
print("ALL Correlations - P-values")
Hmisc::rcorr(as.matrix(lexgist_all))$P

```

I'm also including nicely formatted tables with *** indicators of significance for quick referencing. Order: Deaf, Hearing, All. 

```{r pretty correlations}
corstarsl(lexgist_deaf)
corstarsl(lexgist_hearing)
corstarsl(lexgist_all)
```

## Scatterplot of Correlations
Let's visualize what's happening with the correlations here. 
```{r correlation charts, fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
ggpairs(lexgist_data, columns = c(2:8), aes(color = hearing))
```


# Eye Gaze Data

Now eye gaze data. Boxplots first. Also here, we're renaming "chin" to "neck" because that's what it actually is! But we also have to fix all NA's in the percentages to zeros, becuase that's what they actually are. 
```{r eye gaze boxplot}
# rename chin to neck
fulldata <- fulldata %>%
  rename(neck = chin) %>%
  gather(aoi, percent, belly:upperchest)

# Fix all NA's in Percent column to 0
fixpercent <- fulldata$percent
fulldata$percent <- coalesce(fixpercent, 0)
fulldata <- fulldata %>%
  spread(aoi, percent)

fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(direction, belly:upperchest) %>%
  gather(aoi, percent, belly:upperchest) %>%
  ggplot(aes(x = aoi, y = percent, fill = direction)) + geom_boxplot()
```

But let's try error charts too! Instead of boxplots.

```{r eye gaze error bar chart}
fulldata_error <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  gather(aoi, percent, belly:upperchest) %>%
  group_by(id, direction, aoi) %>%
  summarise(percent = mean(percent, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct() %>%
  group_by(direction, aoi) %>%
  summarise(mean = mean(percent, na.rm = TRUE),
            sd = sd(percent, na.rm = TRUE),
            count = n(),
            se = sd/sqrt(count))
fulldata_error$aoi <- fct_relevel(fulldata_error$aoi, c("forehead","eyes","mouth","neck","upperchest",
                                                        "midchest","lowerchest","belly","left","right"))

fulldata_error %>%
  ggplot(aes(x = aoi, y = mean, fill = direction)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "Eye Gaze Behavior", x = "", y = "looking time") +
  scale_y_continuous(labels = percent, limits = c(0,.70)) + 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1))
```

And a table of eye gaze results too

```{r eye gaze error table}
fulldata_gazetable <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  gather(aoi, percent, belly:upperchest) %>%
  group_by(id, maingroup, direction, aoi) %>%
  summarise(percent = mean(percent, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct() %>%
  group_by(maingroup, direction, aoi) %>%
  summarise(mean = mean(percent, na.rm = TRUE),
            sd = sd(percent, na.rm = TRUE)) %>%
  mutate(mean = round(mean*100,1),
         sd = round(sd*100,1)) %>%
  mutate(value = paste(mean, sd, sep = " ± ")) %>%
  mutate(value = paste(value, "%", sep = ""))

fulldata_gazetable$aoi <- fct_relevel(fulldata_gazetable$aoi, c("forehead","eyes","mouth","neck","upperchest",
                                                        "midchest","lowerchest","belly","left","right"))

fulldata_gazetable %>% 
  ungroup() %>%
  select(-mean, -sd) %>% 
  spread(aoi, value)

fulldata_total <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  gather(aoi, percent, belly:upperchest) %>%
  group_by(aoi) %>%
  summarise(percent = mean(percent, na.rm = TRUE)) %>%
  spread(aoi, percent)

#sum(fulldata_total$eyes, fulldata_total$mouth, fulldata_total$neck)
#fulldata_total$left
#fulldata_total$right
```
## Big Three-Way ANOVA
Now we're going to try a three-way Group x Direction x AOI ANOVA with the top 3 AOIs (Eyes, Mouth, Neck)

```{r big anova aoi3, echo=FALSE, message=FALSE, warning=FALSE, results="markup"}
aoi3 <- c('eyes','mouth','neck')

# Organize the data by those AOIs (but again we need participant-level first)
aoi3_data <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(id, maingroup, hearing, aoasl, age, direction, belly:upperchest) %>%
  gather(aoi, percent, belly:upperchest) %>%
  group_by(id, direction, aoi) %>%
  mutate(percent = mean(percent, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct() %>%
  filter(aoi %in% aoi3) %>%
  spread(aoi, percent)

# # Limit to eyes mouth neck
# big_aov_aoi3 <- aoi3_data %>%
#   gather(aoi, percent, eyes:neck) %>%
#   aov(percent ~ maingroup * direction * aoi, data = .)
# 
# summary(big_aov_aoi3)
# 
# big_aov_aoi3_lsd <- LSD.test(big_aov_aoi3, "aoi", group = FALSE)
# big_aov_aoi3_lsd$comparison

aoi3_data_gather <- aoi3_data %>%
  gather(aoi, percent, eyes:neck) %>%
  filter(id != "6")

big3_aov <- ezANOVA(
  data = aoi3_data_gather,
  dv = percent,
  wid = id,
  within = .(direction, aoi),
  between = maingroup,
  type = 3
)["ANOVA"]

print(big3_aov["ANOVA"])
```
## Left Vs Right
```{r left right anova, echo=FALSE, message=FALSE, warning=FALSE, results="markup"}
aoi3 <- c('left','right')

# Organize the data by those AOIs (but again we need participant-level first)
aoiLR_data <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(id, maingroup, hearing, aoasl, age, direction, belly:upperchest) %>%
  gather(aoi, percent, belly:upperchest) %>%
  group_by(id, aoi) %>%
  mutate(percent = mean(percent, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct() %>%
  filter(aoi %in% aoi3) %>%
  spread(aoi, percent)

aoiLR_data_gather <- aoiLR_data %>%
  gather(aoi, percent, left:right) %>%
  filter(id != "6")

bigLR_aov <- ezANOVA(
  data = aoiLR_data_gather,
  dv = percent,
  wid = id,
  within = aoi,
  between = maingroup,
  type = 3
)["ANOVA"]

print(bigLR_aov["ANOVA"])
```

## Interactions Visualization
So we have significant maingroup:aoi and direction:aoi interactions. Let's try to visualize what can be driving these. We can go back to the SEM chart but break it down...

First are the maingroup:aoi charts *The error bars are not 100% accurate, I took a quick-n-easy way around*

```{r}
aoi3_interactions_maingroupaoi <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(id, participant, maingroup, direction, eyes, mouth, neck) %>%
  gather(aoi, percent, c(eyes, mouth, neck)) %>%
  group_by(id, maingroup, direction, aoi) %>%
  mutate(percent = mean(percent, na.rm = TRUE)) %>%
  distinct() %>%
  group_by(maingroup, aoi) %>%
  summarise(mean = mean(percent, na.rm = TRUE),
            sd = sd(percent, na.rm = TRUE),
            count = n()/2,
            se = sd/sqrt(count))
# I need to first collapse across stories for each participant...here I didn't. Must fix later.

aoi3_interactions_maingroupaoi %>% 
  ggplot(aes(x = aoi, y = mean, fill = maingroup)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "MainGroup & AOI Interaction 1", subtitle = "Error bars represent SE", x = "", y = "percent looking") +
  scale_y_continuous(labels = percent)

aoi3_interactions_maingroupaoi %>% 
  ggplot(aes(x = maingroup, y = mean, fill = aoi)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "MainGroup & AOI Interaction 2", subtitle = "Error bars represent SE", x = "", y = "percent looking") +
  scale_y_continuous(labels = percent)


```

First are the direction:aoi charts *The error bars are not 100% accurate, I took a quick-n-easy way around*

```{r}
aoi3_interactions_directionaoi <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(id, participant, maingroup, direction, eyes, mouth, neck) %>%
  gather(aoi, percent, c(eyes, mouth, neck)) %>%
  group_by(id, maingroup, direction, aoi) %>%
  mutate(percent = mean(percent, na.rm = TRUE)) %>%
  distinct() %>%
  group_by(direction, aoi) %>%
  summarise(mean = mean(percent, na.rm = TRUE),
            sd = sd(percent, na.rm = TRUE),
            count = n(),
            se = sd/sqrt(count))
# I need to first collapse across stories for each participant...here I didn't. Must fix later.

aoi3_interactions_directionaoi %>% 
  ggplot(aes(x = aoi, y = mean, fill = direction)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "MainGroup & Direction Interaction 1", subtitle = "Error bars represent SE", x = "", y = "percent looking") +
  scale_y_continuous(labels = percent)

aoi3_interactions_directionaoi %>% 
  ggplot(aes(x = direction, y = mean, fill = aoi)) + 
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.9), width = 0.5) +
  labs(title = "MainGroup & Direction Interaction 2", subtitle = "Error bars represent SE", x = "", y = "percent looking") +
  scale_y_continuous(labels = percent)
```


## All the AOI means
Let's get tables of our means here, in various configurations

```{r aoi raw, echo = FALSE, results = 'markup'}
aoi3_data %>%
  group_by(maingroup, direction) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(total = sum(eyes,mouth,neck))

aoi3_data %>%
  group_by(maingroup, direction) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  group_by(maingroup) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE))  %>%
  rowwise() %>%
  mutate(total = sum(eyes,mouth,neck))

aoi3_data %>%
  group_by(maingroup, direction) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  group_by(direction) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(total = sum(eyes,mouth,neck))

aoi3_data %>%
  group_by(maingroup, direction) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  group_by(maingroup) %>%
  summarise(eyes = mean(eyes, na.rm = TRUE),
            mouth = mean(mouth, na.rm = TRUE),
            neck = mean(neck, na.rm = TRUE)) %>%
  ungroup() %>% 
  gather(aoi, percent, eyes:neck) %>%
  group_by(aoi) %>%
  summarise(percent = mean(percent, na.rm = TRUE))
```


## Eyes

1. ANOVA with factors MainGroup & Direction.

```{r eyes anova1, echo=FALSE, results = 'markup'}

# # eyes ANCOVA 1
# eyes_aov1 <- aov(eyes ~ maingroup * direction, data = aoi3_data)
# summary(eyes_aov1)
# # eyes_lsd1 <- LSD.test(eyes_aov1, "maingroup", group = FALSE)
# # eyes_lsd1$comparison

aoi3_data <- filter(aoi3_data, id != "6")
ezANOVA(
  data = aoi3_data,
  dv = eyes,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only.

```{r eyes anova2, echo=FALSE, results = 'markup'}
# # eyes ANOVA 2
# eyes_aov2 <- aov(eyes ~ maingroup, data = filter(aoi3_data, direction == "forward"))
# summary(eyes_aov2)
# # eyes_lsd2 <- LSD.test(eyes_aov2, "maingroup", group = FALSE)
# # eyes_lsd2$comparison

ezANOVA(
  data = filter(aoi3_data, direction == "forward"),
  dv = eyes,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

3. ANOVA with factor MainGroup, for Reverse only. 

```{r eyes anova3, echo=FALSE, results = 'markup'}
# # eyes ANOVA 3
# eyes_aov3 <- aov(eyes ~ maingroup, data = filter(aoi3_data, direction == "reversed"))
# summary(eyes_aov3)
# # eyes_lsd3 <- LSD.test(eyes_aov3, "maingroup", group = FALSE)
# # eyes_lsd3$comparison

ezANOVA(
  data = filter(aoi3_data, direction == "reversed"),
  dv = eyes,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

## Mouth

1. ANOVA with factors MainGroup & Direction.

```{r mouth anova1, echo=FALSE, results = 'markup'}

# # mouth ANCOVA 1
# mouth_aov1 <- aov(mouth ~ maingroup * direction, data = aoi3_data)
# summary(mouth_aov1)
# mouth_lsd1 <- LSD.test(mouth_aov1, "maingroup", group = FALSE)
# mouth_lsd1$comparison

ezANOVA(
  data = aoi3_data,
  dv = mouth,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only.

```{r mouth anova2, echo=FALSE, results = 'markup'}
# # mouth ANOVA 2
# mouth_aov2 <- aov(mouth ~ maingroup, data = filter(aoi3_data, direction == "forward"))
# summary(mouth_aov2)
# # mouth_lsd2 <- LSD.test(mouth_aov2, "maingroup", group = FALSE)
# # mouth_lsd2$comparison
ezANOVA(
  data = filter(aoi3_data, direction == "forward"),
  dv = mouth,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

3. ANOVA with factor MainGroup, for Reverse only. 

```{r mouth anova3, echo=FALSE, results = 'markup'}
# # mouth ANOVA 3
# mouth_aov3 <- aov(mouth ~ maingroup, data = filter(aoi3_data, direction == "reversed"))
# summary(mouth_aov3)
# # mouth_lsd3 <- LSD.test(mouth_aov3, "maingroup", group = FALSE)
# # mouth_lsd3$comparison
ezANOVA(
  data = filter(aoi3_data, direction == "reversed"),
  dv = mouth,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

## Neck

1. ANOVA with factors MainGroup & Direction.

```{r neck anova1, echo=FALSE, results = 'markup'}

# # neck ANCOVA 1
# neck_aov1 <- aov(neck ~ maingroup * direction, data = aoi3_data)
# summary(neck_aov1)
# # neck_lsd1 <- LSD.test(neck_aov1, "maingroup", group = FALSE)
# # neck_lsd1$comparison

ezANOVA(
  data = aoi3_data,
  dv = neck,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only.

```{r neck anova2, echo=FALSE, results = 'markup'}
# # neck ANOVA 2
# neck_aov2 <- aov(neck ~ maingroup, data = filter(aoi3_data, direction == "forward"))
# summary(neck_aov2)
# # neck_lsd2 <- LSD.test(neck_aov2, "maingroup", group = FALSE)
# # neck_lsd2$comparison
ezANOVA(
  data = filter(aoi3_data, direction == "forward"),
  dv = neck,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

3. ANOVA with factor MainGroup, for Reverse only. 

```{r neck anova3, echo=FALSE, results = 'markup'}
# # neck ANOVA 3
# neck_aov3 <- aov(neck ~ maingroup, data = filter(aoi3_data, direction == "reversed"))
# summary(neck_aov3)
# # neck_lsd3 <- LSD.test(neck_aov3, "maingroup", group = FALSE)
# # neck_lsd3$comparison
ezANOVA(
  data = filter(aoi3_data, direction == "reversed"),
  dv = neck,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

## FaceChest

We originally defined FaceChest such that

1. Face = eyes + mouth + chin
1. Chest = upperchest + midchest + lowerchest

BUT. Chin is actually neck. It's not even part of the face if you think about it. So I'm redefining FaceChest as:

1. Face = forehead + eyes + mouth
1. Chest = neck + upperchest + midchest + lowerchest

So let's do this. Then see what's happening across groups for FaceChest.

```{r calculate facechest, echo=FALSE, results = 'markup'}
# Calculate face, chest, and facechest - and moutheye too
fulldata <- fulldata %>%
  rowwise() %>%
  mutate(face = sum(forehead, eyes, mouth, na.rm = TRUE),
         chest = sum(neck, upperchest, midchest, lowerchest, na.rm = TRUE),
         facechest = (face - chest)/(face + chest),
         moutheye = (mouth - eyes)/(mouth + eyes))

# fulldata %>% 
#   gather(metric, value, c(facechest_old, facechest)) %>%
#   ggplot(aes(x = maingroup, y = value, fill = direction)) + geom_boxplot() + facet_wrap("metric")
```

Cool. Next we'll do error bar charts using the new FaceChest across groups. 

```{r facechest bars, message=FALSE, warning=FALSE}
facechest_info <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  group_by(maingroup, direction, participant) %>%
  summarise(facechest = mean(facechest, na.rm = TRUE)) %>%
  group_by(maingroup, direction) %>%
  summarise(mean = mean(facechest),
            sd = sd(facechest),
            n = n(),
            se = sd/sqrt(n)) %>%
  ungroup() %>%
  mutate(maingroup = case_when(
    maingroup == "DeafEarly" ~ "Deaf Early",
    maingroup == "DeafLate" ~ "Deaf Late",
    maingroup == "HearingLate" ~ "Hearing Late",
    maingroup == "HearingNovice" ~ "Hearing Novice"
    ))

ggplot(facechest_info, aes(x = maingroup, y = mean, fill = direction, color = direction)) +
  geom_point(stat = "identity", position = position_dodge(0.5), size = 2) + 
  geom_errorbar(aes(ymin = mean-se, ymax = mean+se), position = position_dodge(0.5), width = 0.3, size = 1) +
  labs(title = "Face-Chest Ratio", x = "", y = "face-chest ratio") +
  scale_y_continuous(limits = c(-1,1)) + 
  geom_hline(yintercept = 0, linetype = "dotted") +
  theme_bw()
```

Now let's do the ANOVAs. Also skipping LSDs here. 

1. ANOVA with factors MainGroup & Direction.

```{r facechest anova 1, echo=FALSE, results = 'markup', message=FALSE}
# Create the participant-level db (let's also pop moutheye in this too)
fc_data <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(id, maingroup, hearing, aoasl, age, direction, facechest, moutheye) %>%
  group_by(id, direction) %>%
  mutate(facechest = mean(facechest, na.rm = TRUE),
         moutheye = mean(moutheye, na.rm = TRUE)) %>%
  ungroup() %>%
  distinct() %>%
  filter(id != "6")

# # facechest ANCOVA 1
# facechest_aov1 <- aov(facechest ~ maingroup * direction, data = fc_data)
# summary(facechest_aov1)
# # facechest_lsd1 <- LSD.test(facechest_aov1, "maingroup", group = FALSE)
# # facechest_lsd1$comparison

ezANOVA(
  data = fc_data,
  dv = facechest,
  wid = id,
  within = direction,
  between = maingroup,
  type = 3
)["ANOVA"]
```

2. ANOVA with factor MainGroup, for Forward only.

```{r facechest anova2, echo=FALSE, results = 'markup'}
# # facechest ANOVA 2
# facechest_aov2 <- aov(facechest ~ maingroup, data = filter(fc_data, direction == "forward"))
# summary(facechest_aov2)
# # facechest_lsd2 <- LSD.test(facechest_aov2, "maingroup", group = FALSE)
# # facechest_lsd2$comparison

ezANOVA(
  data = filter(fc_data, direction == "forward"),
  dv = facechest,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

3. ANOVA with factor MainGroup, for Reverse only. 

```{r facechest anova3, echo=FALSE, results = 'markup'}
# # facechest ANOVA 3
# facechest_aov3 <- aov(facechest ~ maingroup, data = filter(fc_data, direction == "reversed"))
# summary(facechest_aov3)
# # facechest_lsd3 <- LSD.test(facechest_aov3, "maingroup", group = FALSE)
# # facechest_lsd3$comparison
ezANOVA(
  data = filter(fc_data, direction == "reversed"),
  dv = facechest,
  wid = id,
  between = maingroup,
  type = 3
)["ANOVA"]
```

# Eye Gaze & Performance Correlations

Next we're going to correlate our eye gaze metrics (Eye, Mouth, Neck, and FaceChest) with lexical recall and gist. Okay! But remember we have a slightly smaller dataset here because we've excluded some participants for having bad eye data (but they had valid behavioral data so we kept them in the AoA-Performance correlations above). 

**We also removed gist_forward column.**

```{r repackage data for correlations again}
eyeperf <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(participant, maingroup, hearing, direction, aoasl, signyrs, acc, gist, eyes, mouth, neck, facechest) %>%
  group_by(maingroup, participant, direction) %>%
  mutate(gist = mean(gist, na.rm = TRUE),
         lex = mean(acc, na.rm = TRUE),
         eyes = mean(eyes, na.rm = TRUE),
         mouth = mean(mouth, na.rm = TRUE),
         neck = mean(neck, na.rm = TRUE),
         facechest = mean(facechest, na.rm = TRUE)) %>%
  ungroup() %>%
  select(maingroup, participant, hearing, direction, aoasl, signyrs, gist, lex, eyes, mouth, neck, facechest) %>%
  distinct() %>%
  gather(metric, value, gist:facechest) %>%
  unite(metricvalue, c(metric, direction), sep = "_") %>%
  spread(metricvalue, value) %>%
  select(-participant, -maingroup) %>%
  select(hearing, aoasl, signyrs, gist_reversed, lex_forward, lex_reversed, eyes_forward, eyes_reversed,
         mouth_forward, mouth_reversed, neck_forward, neck_reversed, facechest_forward, facechest_reversed)

eyeperf_deaf <- eyeperf %>% filter(hearing == "Deaf") %>% select(-hearing)
eyeperf_hearing <- eyeperf %>% filter(hearing == "Hearing") %>% select(-hearing)
eyeperf_all <- eyeperf %>% select(-hearing)


# Correlations for Deaf
print("DEAF Correlations - Pearson's r")
#corstarsl(lexgist_deaf)
Hmisc::rcorr(as.matrix(eyeperf_deaf))$r
print("DEAF Correlations - P-values")
Hmisc::rcorr(as.matrix(eyeperf_deaf))$P
cat(paste("","\n",""))

# Correlations for Hearing
print("HEARING Correlations - Pearson's r")
#corstarsl(lexgist_hearing)
Hmisc::rcorr(as.matrix(eyeperf_hearing))$r
print("HEARING Correlations - P-values")
Hmisc::rcorr(as.matrix(eyeperf_hearing))$P
cat(paste("","\n",""))

# Correlations for All
print("ALL Correlations - Pearson's r")
#corstarsl(lexgist_all)
Hmisc::rcorr(as.matrix(eyeperf_all))$r
print("ALL Correlations - P-values")
Hmisc::rcorr(as.matrix(eyeperf_all))$P

```

I'm also including nicely formatted tables with *** indicators of significance for quick referencing. Order: Deaf, Hearing, All. 

```{r pretty correlations for eyeperf, rows.print = 15}
corstarsl(eyeperf_deaf)
corstarsl(eyeperf_hearing)
corstarsl(eyeperf_all)
```

I'm going to redo the ALL-participants correlations but for forward and reversed seprately. 
```{r  correlations for eyeperffwrv}

eyeperf_fwrv <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(participant, maingroup, hearing, direction, aoasl, signyrs, acc, gist, eyes, mouth, neck, facechest) %>%
  group_by(maingroup, participant, direction) %>%
  mutate(gist = mean(gist, na.rm = TRUE),
         lex = mean(acc, na.rm = TRUE),
         eyes = mean(eyes, na.rm = TRUE),
         mouth = mean(mouth, na.rm = TRUE),
         neck = mean(neck, na.rm = TRUE),
         facechest = mean(facechest, na.rm = TRUE)) %>%
  ungroup() %>%
  select(maingroup, participant, hearing, direction, aoasl, signyrs, gist, lex, eyes, mouth, neck, facechest) %>%
  distinct() %>%
  gather(metric, value, gist:facechest) %>%
  unite(metricvalue, c(metric, direction), sep = "_", remove = FALSE) %>%
  select(-metric) %>%
  spread(metricvalue, value) %>%
  select(-participant, -maingroup, -hearing) %>%
  select(direction, aoasl, signyrs, gist_reversed, lex_forward, lex_reversed, eyes_forward, eyes_reversed,
         mouth_forward, mouth_reversed, neck_forward, neck_reversed, facechest_forward, facechest_reversed)

eyeperf_fw <- eyeperf_fwrv %>% filter(direction == "forward") %>% 
  select(-direction, -gist_reversed, -lex_reversed, -eyes_reversed, -mouth_reversed, -neck_reversed, -facechest_reversed)
eyeperf_rv <- eyeperf_fwrv %>% filter(direction == "reversed") %>% select(-direction, -lex_forward, -eyes_forward, -mouth_forward, -neck_forward, -facechest_forward)

# Correlations for FW
print("FW Correlations - Pearson's r")
#corstarsl(lexgist_deaf)
Hmisc::rcorr(as.matrix(eyeperf_fw))$r
print("FW Correlations - P-values")
Hmisc::rcorr(as.matrix(eyeperf_fw))$P
cat(paste("","\n",""))

# Correlations for RV
print("RV Correlations - Pearson's r")
#corstarsl(lexgist_hearing)
Hmisc::rcorr(as.matrix(eyeperf_rv))$r
print("RV Correlations - P-values")
Hmisc::rcorr(as.matrix(eyeperf_rv))$P
cat(paste("","\n",""))
```

I'm also including nicely formatted tables with *** indicators of significance for quick referencing, forward v. reversed.

```{r pretty correlations for eyeperffwrv, rows.print = 15}
corstarsl(eyeperf_fw)
corstarsl(eyeperf_rv)
```

And the correlation table.

```{r eyeperf correlation charts, fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
ggpairs(eyeperf, columns = c(2:13), aes(color = hearing))
```

# Heat Maps
And finally, we're going to do heat maps. 
```{r heat map}
eyegaze_heat <- fulldata %>%
  ungroup() %>%
  filter(eye_exclude == FALSE) %>%
  select(id:direction, belly, lowerchest, midchest, upperchest, neck, mouth, eyes, forehead) %>%
  gather(aoi, percent, belly:forehead) %>%
  group_by(maingroup, participant, direction, aoi) %>%
  summarise(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,direction,aoi) %>%
  summarise(percent = mean(percent, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(!is.na(aoi)) %>%
  mutate(aoi = factor(aoi,levels=c("belly","lowerchest","midchest",
                                   "upperchest","neck","mouth","eyes","forehead"))) %>%
  ungroup() %>%
  mutate(maingroup = case_when(
    maingroup == "DeafEarly" ~ "Deaf Early",
    maingroup == "DeafLate" ~ "Deaf Late",
    maingroup == "HearingLate" ~ "Hearing Late",
    maingroup == "HearingNovice" ~ "Hearing Novice"
    ))

eyegaze_heat_all <- fulldata %>%
  ungroup() %>%
  filter(eye_exclude == FALSE) %>%
  select(id:direction, belly, lowerchest, midchest, upperchest, neck, mouth, eyes, forehead) %>%
  gather(aoi, percent, belly:forehead) %>%
  group_by(maingroup,participant,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(!is.na(aoi)) %>%
  mutate(aoi = factor(aoi,levels=c("belly","lowerchest","midchest",
                                   "upperchest","neck","mouth","eyes","forehead"))) %>%
  ungroup() %>%
  mutate(maingroup = case_when(
    maingroup == "DeafEarly" ~ "Deaf Early",
    maingroup == "DeafLate" ~ "Deaf Late",
    maingroup == "HearingLate" ~ "Hearing Late",
    maingroup == "HearingNovice" ~ "Hearing Novice"
    ))

ggplot(eyegaze_heat, aes(x = maingroup, y = aoi)) +
  geom_tile(aes(fill=percent),color="lightgray",na.rm=TRUE) + 
  scale_fill_viridis(option = "viridis", direction=-1, limits = c(0,.71), labels = percent, name = "looking time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=30,hjust=1),
        strip.text.x = element_text(size = 11, color = "black", face = "italic"), 
        strip.background = element_rect(colour = "white", fill = "white"),
        panel.grid.major = element_line(color = "white")) +
  facet_grid(. ~ direction) +
  ylab("") + xlab("") + ggtitle("Eye Gaze Heat Map, by Direction") + 
  scale_y_discrete(expand=c(0,0)) +
  scale_x_discrete(expand = c(0,0))


ggplot(eyegaze_heat_all, aes(x = maingroup, y = aoi)) +
  geom_tile(aes(fill=percent),color="lightgray",na.rm=TRUE) + 
  scale_fill_viridis(option = "viridis", direction=-1, limits = c(0,.71), labels = percent, name = "looking time") +
  theme_bw() +
  theme(axis.text.x=element_text(angle=30,hjust=1), 
  panel.grid.major = element_line(color = "white")) +
  ylab("") + xlab("") + ggtitle("Eye Gaze Heat Map (Direction Collapsed)") +
  scale_y_discrete(expand=c(0,0)) +
  scale_x_discrete(expand = c(0,0))

```

# Summary

Below are the p-values from the ANOVAs with 4 MainGroups. I never included Age as a covariate because it never improved the model. I included all ANOVAs for Gist and Lex Recall, and ANOVAs for any eye AOI or ratio was included only if either maingroup or direction was significant. Deafearly-Deaflate shows the LSD p-value for that comparison.
```{r results1, rows.print = 20}
results1 <- structure(list(model = c("gist-maingroup-both", "gist-maingroup-fw", 
"gist-maingroup-rv", "lexrecall-maingroup-both", "lexrecall-maingroup-fw", 
"lexrecall-maingroup-rv", "mouth-maingroup-both", "upperchest-maingroup-both", 
"upperchest-maingroup-rv", "facechest-maingroup-both", "moutheye-maingroup-both"
), maingroup = c(0, 0, 0.01, 0, 0.04, 0.02, 0.06, 0, 0.01, 0.1, 
0.05), direction = c(0, NA, NA, 0, NA, NA, 0.06, 0.16, NA, 0.07, 
0.48), `deafearly-deaflate` = c(0.1, 0.69, 0.02, 0.11, 0.95, 
0.06, 0.38, 0.94, 0.52, 0.08, 0.68)), .Names = c("model", "maingroup", 
"direction", "deafearly-deaflate"), class = c("tbl_df", "tbl", 
"data.frame"), row.names = c(NA, -11L))

results1
```

And below are the p-values from the ANCOVAs with Hearing & AoASL. I included all ANCOVAs for Gist and Lex Recall, and ANCOVAs for any eye AOI or ratio was included only if any main factor was significant. LSD comparisons are not needed because there's only 2 levels in each group!

```{r results2, rows.print = 25}
results2 <- structure(list(model = c("gist-both", "gist-fw", "gist-rv", "lex-both", 
"lex-fw", "lex-rv", "forehead-fw", "mouth-both", "mouth-rv", 
"upperchest-both", "upperchest-rv", "facechest-both", "moutheye-both"
), hearing = c(0, 0.00, 0.01, 0.01, 0.22, 0.03, 0.06, 0.01, 
0.04, 0.01, 0.01, 0.35, 0.07), direction = c(0, NA, NA, 0, NA, 
NA, NA, 0.05, NA, 0.21, NA, 0.05, 0.52), aoasl = c(0.22, 0.77, 
0.19, 0.56, 0.58, 0.25, 0.08, 0.06, 0.12, 0.68, 0.95, 0.12, 0.44
), age = c(0.08, 0.01, 0.86, 0.09, 0.02, 0.7, 0.68, 0.28, 0.5, 
0.02, 0.08, 0.00, 0.21)), .Names = c("model", "hearing", "direction", 
"aoasl", "age"), class = c("tbl_df", "tbl", "data.frame"), row.names = c(NA, 
-13L))
results2
```

Finally, the correlations for Deaf and Hearing separately are not significant. But there are significant correlations across all participants. I worry it is caused by HearingNovice, though...

```{r correlation table}
results3 <- tribble(
  ~ metric, ~ AoASLcorrelationRvalue, ~ Pvalue,
  "gist-fw", -0.32, 0.019,
  "gist-rv", -0.39, 0.004,
  "lex-fw", -0.08, 0.567,
  "lex-rv", -0.34, 0.014
)
results3
```

# Ternary Plots

Let's make triangle plots. "What?" you say. Read on. 

```{r fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
library(ggtern)
fulldata %>% 
  ggtern(aes(x = eyes, y = mouth, z = neck)) + facet_grid(direction ~ maingroup) + stat_density_tern(geom='polygon', aes(fill=..level..), bins=4) + geom_point(color = "white", alpha = 0.5) + theme_bw()

fulldata %>% 
  ggtern(aes(x = eyes, y = mouth, z = neck)) + facet_grid(direction ~ maingroup) + geom_confidence_tern(breaks = c(.5), color = "red") + geom_point() + theme_bw()
```

# Rain's Notes
About Adults:

-I think I want to write it up as an ANCOVA, with direction included.  And LSD comparisons instead of Tukey.  (I will do my own corrections)
-You often have one liners summarizing results, in all tabs, those are nice, keep them coming.
-(If you have reasons to present anything other than the ANCOVA, put that in your results tab)
 
I think if we do it this way then we get a really important story to tell:  That the *critical* AoA cutoff is below 4 vs above 4 years of age (two groups 0-4 vs 4-13).  This suggest early ASL is important.  

```{r eval=FALSE, include=FALSE}
# Gist as binomial logit-link function model
gist_glmm <- glmer(gist ~ direction * maingroup + (1|id) + (1|story), data = fulldata, family=binomial (link="logit"))
summary(gist_glmm)
```

# Viewing Space Correlations 

Okay now let's work with the raw viewing space that we created in [05viewingspace](05viewingspace.nb.html). For each participant the first 30 samples was removed. 

+ box width
+ upper limit
+ lower limit
+ left side
+ right side
+ height
+ box center position
+ area

correlated with 

+ gist
+ lexical recall
+ sign years
+ aoasl

Here's sample of the raw viewing data structure. 

```{r}
viewing <- read_csv('adultviewingspaceraw.csv') 
head(viewing, 10)
```

Now I'm going to compute the following metrics with the following definitions!

+ *upper* (75th percentile on y-axis)
+ *lower* (25th percentile on y-axis)
+ *left* (25th percentile on x-axis)
+ *right* (75th percentile on x-axis)
+ *width* (x-axis IQR)
+ *height* (y-axis IQR)
+ *x-center* (median x-axis)
+ *y-center* (median y-axis)
+ *area* (x-axis IQR * y-axis IQR)

```{r}
# compute viewing metrics
viewing_metrics <- viewing %>%
  group_by(participant, direction, media) %>%
  summarise(
    upper = quantile(y,na.rm=TRUE)[[2]],
    lower = quantile(y,na.rm=TRUE)[[4]],
    left = quantile(x,na.rm=TRUE)[[2]],
    right = quantile(x,na.rm=TRUE)[[4]],
    width = IQR(x,na.rm=TRUE),
    height = IQR(y,na.rm=TRUE),
    x_center = median(x,na.rm=TRUE),
    y_center = median(y,na.rm=TRUE),
    area = width*height
    )

# average across two stories for each direction
viewing_metrics <- viewing_metrics %>%
  group_by(participant, direction) %>%
  summarise_if(is.numeric, funs(mean(., na.rm = TRUE)))

head(viewing_metrics,10)
```

The participant names are different than what we've been using, so I'm going to fix that. Then I'll join the behavioral data with the viewing space metrics.

**Notes to self - which Alicia (Deaf or 2?) - add Gina in - add Jesse in - add JJ in - Laura 1 or Laura 2 - MarlaMarks or MarlaH - add Matthew - add Ranem**

Below is an example of the forward table for viewing space and behavioral data

```{r}
# Fix participant names
partnames <- read_csv("partnames.csv") %>% 
  distinct() %>% 
  mutate(participant = as.character(participant),
         new_participant = as.character(new_participant))
viewing_metrics_fixed <- viewing_metrics %>%
  ungroup() %>%
  mutate(participant = as.character(participant)) %>%
  left_join(partnames, by = "participant") %>%
  select(-participant) %>%
  rename(participant = new_participant) %>%
  filter(!is.na(participant)) %>%
  select(participant, direction:area)

# Get behavioral measures
eyeperf_fwrv <- fulldata %>%
  filter(eye_exclude == FALSE) %>%
  select(participant, maingroup, hearing, direction, aoasl, signyrs, acc, gist, eyes, mouth, neck, facechest) %>%
  group_by(maingroup, participant, direction) %>%
  mutate(gist = mean(gist, na.rm = TRUE),
         lex = mean(acc, na.rm = TRUE),
         eyes = mean(eyes, na.rm = TRUE),
         mouth = mean(mouth, na.rm = TRUE),
         neck = mean(neck, na.rm = TRUE),
         facechest = mean(facechest, na.rm = TRUE)) %>%
  ungroup() %>%
  select(maingroup, participant, hearing, direction, aoasl, signyrs, gist, lex) %>%
  distinct()

viewing_metrics_behav <- 
  left_join(viewing_metrics_fixed, eyeperf_fwrv, by = c("participant","direction")) %>%
  filter(!is.na(maingroup)) %>%
  select(participant, direction, maingroup:lex, upper:area) %>%
  gather(metric, value, gist:area) %>%
  unite(metricvalue, c(metric, direction), sep = "_", remove = FALSE) %>%
  select(-metric) %>%
  spread(metricvalue, value) %>%
  select(-participant, -maingroup, -hearing)

viewing_fw <- viewing_metrics_behav %>% 
  filter(direction == "forward") %>% 
  select(aoasl,
         signyrs,
         gist_forward, 
         lex_forward, 
         upper_forward, 
         lower_forward, 
         left_forward, 
         right_forward, 
         width_forward, 
         height_forward, 
         x_center_forward, 
         y_center_forward,
         area_forward)
viewing_rv <- viewing_metrics_behav %>% 
  filter(direction == "reversed") %>% 
  select(aoasl,
         signyrs,
         gist_reversed, 
         lex_reversed, 
         upper_reversed, 
         lower_reversed, 
         left_reversed, 
         right_reversed, 
         width_reversed, 
         height_reversed, 
         x_center_reversed, 
         y_center_reversed,
         area_reversed)

head(viewing_fw,10)
```

I'll show the pretty correlations table first. Forward and reversed in that order. 

```{r pretty correlations for viewing, rows.print = 15}
corstarsl(viewing_fw)
corstarsl(viewing_rv)
```

Now the Pearson's r correlations and p-values for forward and reversed stories in that order. 
```{r}
# Correlations for FW
print("FW Correlations - Pearson's r")
Hmisc::rcorr(as.matrix(viewing_fw))$r
print("FW Correlations - P-values")
Hmisc::rcorr(as.matrix(viewing_fw))$P
cat(paste("","\n",""))

# Correlations for RV
print("RV Correlations - Pearson's r")
Hmisc::rcorr(as.matrix(viewing_rv))$r
print("RV Correlations - P-values")
Hmisc::rcorr(as.matrix(viewing_rv))$P
cat(paste("","\n",""))
```

