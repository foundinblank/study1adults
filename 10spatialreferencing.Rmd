---
title: "Spatial Referencing"
author: "Adam Stone, PhD"
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  html_notebook:
    code_folding: hide
    highlight: tango
    theme: paper
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r}
## Reads in AOI position text files from Toii
## Will return tibble of columns sec, x, y, with rows for each timestamp/AOI position

get_xy_timestamp <- function(z){

x <- read_lines(z) %>%
  as_tibble() %>%
  rowid_to_column("ID")

# pull out timestamp rows
timestamps <- x %>%
  filter(str_detect(value, "timestamp")) %>%
  separate(value, into = c("throw","timestamp"), sep = " = ") %>%
  separate(timestamp, into = c("one","two","sec"), sep = ":") %>%
  select(sec) %>%
  mutate(sec = as.numeric(sec))

# Find AOI coordinate rows
xys <- x %>%
  mutate(find = str_detect(value, "X\tY"))

# first vertex (2 rows after each "XY" line)
xys_row <- which(xys$find) + 2

xy1 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x1","y1"), sep = "\t") %>%
  select(-ID)

# opposite vertex (2 more rows down)
xys_row <- xys_row + 2

xy2 <- x %>%
  filter(ID %in% xys_row) %>%
  separate(value, into = c("x2","y2"), sep = "\t") %>%
  select(-ID)

# Now get average XY position per timestamp
xys <- cbind(timestamps, xy1, xy2) %>%
  mutate_all(as.numeric) %>%
  rowwise() %>%
  mutate(x = mean(x1,x2),
         y = mean(y1, y2)) %>%
  select(sec, x, y)
}
```

Let's give this a shot!!

# Three Bears Forward 
First let's see who's in our dataset. This is Test 1 - 3 Bears - Forward. We're pulling cleaned-up names and assigned groups from our final dataset that we used in our AOI analysis. Then we are removing participants whose Three Bears Forward story wasn't included in our AOI analysis due to <25% looking time or other reasons. 

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(openxlsx)
library(janitor)

# Get Three Bears data
data <- read.xlsx("Test1_Cindy_bears_FW_Examine for Spatial Referencing.xlsx") %>%
  clean_names() %>%
  rename(y = gazepointy_mcspx,
         language = x_language_value,
         name = participantname,
         group = x_group_value)

# Pull clean names and join to data (and add Laura2 for Laura (missing stories))
cleannames <- read_csv("partnames.csv") %>%
  distinct() %>%
  rename(name = participant) %>%
  filter(name != "Laura2")

data <- data %>% 
  left_join(cleannames, by = "name") %>%
  select(-name) %>%
  rename(name = new_participant) %>%
  filter(!is.na(name))

# Pull final group assignments and join to data
cleangroups <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup) %>%
  rename(name = participant) %>%
  distinct()

data <- data %>% left_join(cleangroups, by = "name") %>%
  select(-group)

# Let's find out who was NOT included in Three Bears
excluded <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup, story, direction, eye_exclude) %>%
  filter(story == "Goldilocks" & direction == "forward") %>%
  rename(name = participant) %>%
  select(name, eye_exclude)

data <- data %>% left_join(excluded, by = "name") %>%
  filter(!eye_exclude) %>%
  filter(!is.na(eye_exclude))

data %>% select(name, maingroup) %>% distinct()
```

Now let's graph!! 

Messy, I know, but already we can see some HearingNovice has big shifts downward. And some HearingLate too.

```{r}
data %>%
  ggplot(aes(x = gazepointindex, y = y, color = maingroup, group = name)) + geom_line() + 
  scale_y_reverse() +
  theme_bw()
```

Next let's plot the moments where spatial referencing happens. Those are frames

1. 198 to 223
1. 265 to 288
1. 352 to 380

The max gazepointindex is around 2580. At 120 Hz, that's 21.5 seconds which is just right, that's the length. Let's go ahead and convert gazepointindex to seconds.  

So we just have to convert frames to gazepointindex. The video is a total of 536 frames, at 25 FPS that's 21.5 seconds. 535/25 = 21.5, so we divide all those frames by 25. 

1. 7.92s to 8.92s
1. 10.6s to 11.52s
1. 14.08s to 15.2s 

And plot those!

```{r}
data <- data %>%
  rowwise() %>%
  mutate(secs = gazepointindex/120)

data %>%
  ggplot(aes(x = secs, y = y, color = maingroup, group = name)) + 
  scale_y_reverse() + 
  geom_line() + 
  annotate("rect", xmin = 7.92, xmax = 8.92, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 10.6, xmax = 11.52, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 14.08, xmax = 15.2, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  theme_bw()
```

Maybe easier if we separate groups of signers. 

```{r}
data %>%
  ggplot(aes(x = secs, y = y, color = maingroup, group = name)) + 
  scale_y_reverse() + 
  geom_line(alpha = 0.5) + 
  annotate("rect", xmin = 7.92, xmax = 8.92, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 10.6, xmax = 11.52, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 14.08, xmax = 15.2, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(maingroup ~ .) +
  theme_bw() +
  guides(color = FALSE)
```

Next, we're going to add AOI position information. We're going to pull in information on signers' right hand position (and then apply the same idea to other body parts). I successfully wrote a function called `get_xy_timestamp` to do this! Yay. I'm chuffed, as the British would say.

Let's try this on Stephanie's data.

```{r}
rhand <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of Right Hand.txt")
lhand <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of Left Hand.txt")
mouth <- get_xy_timestamp("aoi_position/Cindy_bears_FW_Position of mouth small.txt")

steph <- filter(data, name == "Stephanie")

steph %>%
  ggplot(aes(x = secs, y = y)) + 
  scale_y_reverse() + 
  geom_line(alpha = 1, color = "purple") + 
  annotate("rect", xmin = 7.92, xmax = 8.92, ymin = 0, ymax = 1200,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 10.6, xmax = 11.52, ymin = 0, ymax = 1200,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 14.08, xmax = 15.2, ymin = 0, ymax = 1200,
  alpha = .2, fill = "red") +
  geom_step(data = rhand, aes(x = sec, y = y), color = "red", linetype = "longdash", alpha = 0.5) + 
  geom_step(data = lhand, aes(x = sec, y = y), color = "blue", linetype = "longdash", alpha = 0.5) + 
  geom_step(data = mouth, aes(x = sec, y = y), color = "black", linetype = "longdash", alpha = 0.5) + 
  annotate("text", label = "Right Hand", x = 3, y = 1000, color = "red", alpha = 0.5) +
  annotate("text", label = "Left Hand", x = 3, y = 1100, color = "blue", alpha = 0.5) +
  annotate("text", label = "Mouth", x = 3, y = 200, color = "black", alpha = 0.5) +
  ggtitle("Stephanie") +
  theme_bw() +
  theme(panel.grid.minor.y = element_blank())
```

Hmm hmm. HearingNovice do have a lot of down shifts but they're not CLEARLY lining up with spatial referencing...or so we think. Let's separate out individual signers. 

```{r}
make_signer_plots <- function(groupname, line_color) {
  data %>%
  filter(maingroup == groupname) %>%
  ggplot(aes(x = secs, y = y)) + 
  scale_y_reverse() + 
  geom_line(alpha = 1, color = line_color) + 
  annotate("rect", xmin = 7.92, xmax = 8.92, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 10.6, xmax = 11.52, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 14.08, xmax = 15.2, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  geom_step(data = rhand, aes(x = sec, y = y), color = "red", linetype = "longdash", alpha = 0.5) + 
  geom_step(data = lhand, aes(x = sec, y = y), color = "blue", linetype = "longdash", alpha = 0.5) + 
  geom_step(data = mouth, aes(x = sec, y = y), color = "black", linetype = "longdash", alpha = 0.5) + 
  annotate("text", label = "Right Hand", x = 3, y = 1000, color = "red", alpha = 0.5) +
  annotate("text", label = "Left Hand", x = 3, y = 1100, color = "blue", alpha = 0.5) +
  annotate("text", label = "Mouth", x = 3, y = 200, color = "black", alpha = 0.5) +
  facet_grid(name ~ .) +
  ggtitle(groupname) +
  theme_bw()
}

make_signer_plots("DeafEarly", "red")
make_signer_plots("DeafLate", "dark green")
make_signer_plots("HearingLate", "blue")
make_signer_plots("HearingNovice", "purple")
```

Okay so with Early ASL obviously very steady gaze. NoviceASL has lot of downshifts. Some align with spatial referencing, some do not. We need more of them (let's look at other stories w better data). 


# Midas Forward

```{r message=FALSE, warning=FALSE}
# Get Midas data
data <- read_csv("../Adult Data/rawdata/midasfw.csv") %>%
  clean_names() %>%
  rename(y = gazepointy_mcspx,
         language = x_language_value,
         name = participantname,
         group = x_group_value)

# Pull clean names and join to data
cleannames <- read_csv("partnames.csv") %>%
  distinct() %>%
  rename(name = participant)

data <- data %>% left_join(cleannames, by = "name") %>%
  select(-name) %>%
  rename(name = new_participant) %>%
  filter(!is.na(name))

# Pull final group assignments and join to data
cleangroups <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup) %>%
  rename(name = participant) %>%
  distinct()

data <- data %>% left_join(cleangroups, by = "name") %>%
  select(-group)

# Let's find out who was NOT included in Three Bears
excluded <- read_csv("finaldataset.csv") %>%
  select(participant, maingroup, story, direction, eye_exclude) %>%
  filter(story == "KingMidas" & direction == "forward") %>%
  rename(name = participant) %>%
  select(name, eye_exclude)

data <- data %>% left_join(excluded, by = "name") %>%
  filter(!eye_exclude) %>%
  filter(!is.na(eye_exclude))

data %>% select(name, maingroup) %>% distinct()
```

Now let's graph!! 

Hm. One person seems wrong. 
```{r}
data %>%
  ggplot(aes(x = gazepointindex, y = y, color = maingroup, group = name)) + geom_line() + scale_y_reverse()
```
Okay it's Jesse's data that seems off. We'll remove him for now and come back to it, figure out why. 
```{r}
data %>% filter(gazepointindex > 30000) %>% select(name) %>% distinct() %>% head()
```

```{r}
data <- data %>%
  filter(name != "Jesse")

data %>%
  ggplot(aes(x = gazepointindex, y = y, color = maingroup, group = name)) + geom_line() + 
  scale_y_reverse() +
  scale_x_continuous(limits = c(0,4500))
```

Next let's plot the moments where spatial referencing happens. Those are frames

1. 248 to 427
1. 460 to 508
1. 512 to 560

Like before, we'll convert gazepointindex to seconds (by dividing 120) and all frames to seconds (by dividing 25). 

1. 9.92s to 17.08s
1. 18.4s to 20.32s
1. 20.48s to 22.4s 

```{r}
data <- data %>%
  rowwise() %>%
  mutate(secs = gazepointindex/120)

data %>%
  ggplot(aes(x = secs, y = y, color = maingroup, group = name)) + 
  scale_y_reverse() + 
  scale_x_continuous(limits = c(0, 37.5)) +
  geom_line() + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red")
```

Maybe easier if we separate groups of signers. 

```{r}
data %>%
  ggplot(aes(x = secs, y = y, color = maingroup, group = name)) + 
  scale_y_reverse() + 
  scale_x_continuous(limits = c(0, 37.5)) +
  geom_line(alpha = 0.5) + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(maingroup ~ .)
```

Individual signers. 

```{r}
data %>%
  filter(maingroup == "DeafEarly") %>%
  ggplot(aes(x = secs, y = y, group = name)) + 
  scale_x_continuous(limits = c(0, 37.5)) +
  scale_y_reverse() + 
  geom_line(alpha = 1, color = "red") + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(name ~ .) +
  ggtitle("DeafEarly")

data %>%
  filter(maingroup == "DeafLate") %>%
  ggplot(aes(x = secs, y = y, group = name)) + 
  scale_y_reverse() + 
  scale_x_continuous(limits = c(0, 37.5)) +
  geom_line(alpha = 1, color = "dark green") + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(name ~ .) +
  ggtitle("DeafLate")

data %>%
  filter(maingroup == "HearingLate") %>%
  ggplot(aes(x = secs, y = y, group = name)) + 
  scale_y_reverse() + 
  scale_x_continuous(limits = c(0, 37.5)) +
  geom_line(alpha = 1, color = "blue") + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(name ~ .) +
  ggtitle("HearingLate")

data %>%
  filter(maingroup == "HearingNovice") %>%
  ggplot(aes(x = secs, y = y, group = name)) + 
  scale_y_reverse() + 
  scale_x_continuous(limits = c(0, 37.5)) +
  geom_line(alpha = 1, color = "purple") + 
  annotate("rect", xmin = 9.92, xmax = 17.08, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 18.4, xmax = 20.32, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  annotate("rect", xmin = 20.48, xmax = 22.4, ymin = 0, ymax = 900,
  alpha = .2, fill = "red") +
  facet_grid(name ~ .) +
  ggtitle("HearingNovice")
```