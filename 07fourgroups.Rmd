---
title: "Four Groups (study1adults)"
author: "Adam Stone, PhD" 
date: '`r format(Sys.Date(), "%m-%d-%Y")`'
output:
  github_document:
    toc: yes
    toc_depth: 2
  html_notebook:
    code_folding: hide
    theme: paper
    highlight: tango
    toc: yes
    toc_depth: 2
    toc_float: yes
    df_print: paged
---

# Introduction 
Let's see what happens when we use FOUR groups instead of FIVE. I'm cutting off AoASL at 7 years - younger than that is "Early", older than that is "Late."

# Participants
```{r warning=FALSE}
# Load libraries
library(tidyverse)
library(stringr)
library(lme4)
library(lmerTest)
library(prettydoc)
library(broom)
library(knitr)
library(xtable)
library(kableExtra)
library(viridis)
library(cowplot)
options(knitr.table.format = "html") 

# Import data!
data <- read_csv('cleanpercentdata.csv',col_types = 
                   cols(
                     id = col_integer(),
                     participant = col_character(),
                     hearing = col_character(),
                     videogroup = col_character(),
                     aoagroup = col_character(),
                     languagegroup = col_character(),
                     maingroup = col_character(),
                     video = col_character(),
                     story = col_character(),
                     direction = col_character(),
                     age = col_double(),
                     selfrate = col_double(),
                     signyrs = col_double(),
                     aoasl = col_integer(),
                     acc = col_double(),
                     aoi = col_character(),
                     percent = col_double()
                   ))

# And factorize
data <- data %>%
  mutate(participant = as.factor(participant)) %>%
  mutate(id = as.factor(id)) %>%
  mutate(hearing = as.factor(hearing)) %>%
  mutate(videogroup = as.factor(videogroup)) %>%
  mutate(aoagroup = as.factor(aoagroup)) %>%
  mutate(languagegroup = as.factor(languagegroup)) %>%
  mutate(maingroup = as.factor(maingroup)) %>%
  mutate(video = as.factor(video)) %>%
  mutate(story = as.factor(story)) %>%
  mutate(direction = as.factor(direction)) %>%
  mutate(aoi = as.factor(aoi))

# Remove ASL from the end of MainGroup names
data <- data %>%
  mutate(maingroup = case_when(
    str_detect(maingroup,"DeafNative") ~ "DeafNative",
    str_detect(maingroup,"DeafEarlyASL") ~ "DeafEarly",
    str_detect(maingroup,"DeafLateASL") ~ "DeafLate",
    str_detect(maingroup,"HearingLateASL") ~ "HearingLate",
    str_detect(maingroup,"HearingNoviceASL") ~ "HearingNovice"
  )) %>%
  mutate(maingroup = if_else(hearing=="Deaf" & aoasl < 7, "DeafEarly", maingroup)) %>% 
  mutate(maingroup = if_else(hearing=="Deaf" & aoasl > 7, "DeafLate", maingroup)) %>%
  mutate(maingroup = as.factor(maingroup))

# Set reference levels for maingroup
data$maingroup <- relevel(data$maingroup, ref="DeafEarly")

dataoriginal <- data # Save item-level data just in case

# Take out HearingNoviceASL
# data <- data %>%
#   filter(maingroup!="HearingNoviceASL")

# Load awesome function to make correlation tables with stars for significance
# From: https://myowelt.blogspot.co.uk/2008/04/beautiful-correlation-tables-in-r.html
corstarsl <- function(x){ 
require(Hmisc) 
x <- as.matrix(x) 
R <- Hmisc::rcorr(x)$r 
p <- Hmisc::rcorr(x)$P 
## define notions for significance levels; spacing is important.
mystars <- ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "* ", " ")))
## trunctuate the matrix that holds the correlations to two decimal
R <- format(round(cbind(rep(-1.11, ncol(x)), R), 2))[,-1] 
## build a new matrix that includes the correlations with their apropriate stars 
Rnew <- matrix(paste(R, mystars, sep=""), ncol=ncol(x)) 
diag(Rnew) <- paste(diag(R), " ", sep="") 
rownames(Rnew) <- colnames(x) 
colnames(Rnew) <- paste(colnames(x), "", sep="") 
## remove upper triangle
Rnew <- as.matrix(Rnew)
Rnew[upper.tri(Rnew, diag = TRUE)] <- ""
Rnew <- as.data.frame(Rnew) 
## remove last column and return the matrix (which is now a data frame)
Rnew <- cbind(Rnew[1:length(Rnew)-1])
return(Rnew) 
}


# # Now collapse eye gaze data to subject-level 
# data <- data %>%
#   group_by(participant,direction,aoi) %>%
#   dplyr::summarize(percent = mean(percent,na.rm=TRUE))
# data[data=="NaN"] <- NA
# 
# # Join subject info with data that's now subject-level
# data <- left_join(data,data.subjectinfo, by=c("participant","direction"))


# But now we need to go back and add in a complete lexical recall dataset, even including those trials that got thrown out in 03eyegaze.nb.html. Because the lexical accuracy data is still good. So let's work on that. 
cleanlexdata <- read_csv('cleandata.csv',col_types = 
                   cols(
                     id = col_integer(),
                     participant = col_character(),
                     hearing = col_character(),
                     videogroup = col_character(),
                     aoagroup = col_character(),
                     languagegroup = col_character(),
                     maingroup = col_character(),
                     video = col_character(),
                     story = col_character(),
                     direction = col_character(),
                     age = col_double(),
                     selfrate = col_double(),
                     signyrs = col_double(),
                     aoasl = col_integer(),
                     acc = col_double(),
                     forehead = col_double(),
                     eyes = col_double(),
                     mouth = col_double(),
                     chin = col_double(),
                     upperchest = col_double(),
                     midchest = col_double(),
                     lowerchest = col_double(),
                     belly = col_double(),
                     left = col_double(),
                     right = col_double(),
                     total = col_double()
                   )) %>%
  mutate(maingroup = case_when(
    str_detect(maingroup,"DeafNative") ~ "DeafNative",
    str_detect(maingroup,"DeafEarlyASL") ~ "DeafEarly",
    str_detect(maingroup,"DeafLateASL") ~ "DeafLate",
    str_detect(maingroup,"HearingLateASL") ~ "HearingLate",
    str_detect(maingroup,"HearingNoviceASL") ~ "HearingNovice"
  )) %>%
  mutate(maingroup = if_else(hearing=="Deaf" & aoasl < 7, "DeafEarly", maingroup)) %>% 
  mutate(maingroup = if_else(hearing=="Deaf" & aoasl > 7, "DeafLate", maingroup)) %>%
  mutate(maingroup = as.factor(maingroup))

cleanlexdata$maingroup <- relevel(cleanlexdata$maingroup, ref="DeafEarly")


# Pull out subject info for later in summary tables
subjectinfo <- data %>%
  select(-aoi,-percent,-video,-story,-direction,-acc) %>%
  distinct()

# Participant Characteristics Table (using cleanlexdata because it's more complete)
groupmeans <- cleanlexdata %>%
  ungroup() %>%
  select(id,participant,maingroup,age,selfrate,signyrs,aoasl) %>%
  distinct() %>%
  group_by(maingroup) %>%
  dplyr::summarize(n = n(),
            age.m = mean(age),
            age.sd = sd(age),
            selfrate.m = mean(selfrate),
            selfrate.sd = sd(selfrate),
            signyrs.m = mean(signyrs),
            signyrs.sd = sd(signyrs),
            aoasl.m = mean(aoasl),
            aoasl.sd = sd(aoasl)) %>%
  mutate(maingroup =  factor(maingroup, levels = c("DeafEarly","DeafLate",
                                                   "HearingLate","HearingNovice"))) %>%
  arrange(maingroup)    
kable(groupmeans, digits=1) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Let's see the distribution of AoASL among the four groups. 
```{r}
data %>%
  select(participant,maingroup,aoasl) %>%
  distinct() %>%
  ggplot(aes(x = aoasl, fill = maingroup)) + 
  geom_histogram(binwidth = .5) + 
  facet_grid(maingroup ~ .) +
  ylab("Age of ASL Acquisition") + ggtitle("Distribution of ASL Acquisition Ages")
```

# Lexical Recall
Let's get their lex recall scores. 
```{r}
cleanlexdata %>%
  ggplot(aes(x = maingroup, y = acc, fill = direction)) +
  geom_boxplot() +
  scale_y_continuous(limits = c(0,1), labels = scales::percent) +
  ggtitle("Lexical Recall Scores") + xlab("") + ylab("Accuracy")
```

Would a LMM show differences? Let's see. Below, there is a main effect of direction (p < 0.001) and a main effect of maingroup for Hearing Novice (p = 0.03), and then a weak interaction for Direction & HearingLate (p = 0.047). 
```{r}
lex_recall_lmm <- lmer(acc ~ maingroup * direction + (1|id) + (1|story), data = cleanlexdata)
summary(lex_recall_lmm)
```

How about a traditional ANOVA? It tells us - main effect of direction (p < 0.001), main effect of group (p = 0.004), but no significant interactions. The Tukey's posthoc tells us the main effect of group is driven by a difference between DeafEarly and HearingNovice (p = 0.002), and no other contrasts.  

```{r}
lexdata_subjects <- cleanlexdata %>%
  group_by(maingroup,participant,direction) %>%
  dplyr::summarize(acc = mean(acc,na.rm=TRUE))

lex_recall_aov <- aov(acc ~ maingroup * direction, data = lexdata_subjects)
summary(lex_recall_aov)
TukeyHSD(lex_recall_aov, "maingroup", conf.level = 0.95)
```

What about the recovery metric for reversed stories? 
```{r}
lex_recovery <- cleanlexdata %>%
  select(maingroup, participant, video, acc) %>%
  filter(video == "rv2" | video == "rv4") %>%
  spread(video, acc) %>%
  mutate(recov = rv4-rv2) %>%
  select(maingroup, participant, recov)

lex_recovery %>%
  ggplot(aes(x = maingroup, y = recov, fill = maingroup)) +
  geom_boxplot() +
  scale_y_continuous(labels = scales::percent) +
  ggtitle("Recovery in Reversed Stories") + xlab("") + ylab("Accuracy Change") +
  geom_hline(yintercept = 0, linetype = "dotted")
```

Is there a real effect of group? Simple LM first. No effect of group. No need to do ANOVA, it's the same math.
```{r}
lex_recov_lm <- lm(recov ~ maingroup, data = lex_recovery)
summary(lex_recov_lm)
```

# Eye Gaze
We already know the best AOIs are eyes, mouth, chin, and FaceChest Ratio. So let's just plot all those out. The y-axis for FaceChest is of course not percent but a ratio, 1.0 to -1.0 (but no one goes below 0).

```{r}
eyegaze <- data %>%
  filter(aoi == "eyes" | aoi == "mouth" | aoi == "chin" | aoi == "facechest")

ggplot(eyegaze, aes(x = maingroup, y = percent, fill = direction)) + 
  geom_boxplot() + 
  facet_wrap("aoi") +
  scale_y_continuous(labels = scales::percent) +
  ylab("Percent Looking") + xlab("") + ggtitle("Eye Gaze Beahvior") +
  theme(axis.text.x = element_text(angle = 45,hjust = 1))
```

Heat map next. 

```{r}
eyegaze_heat <- data %>%
  ungroup() %>%
  filter(aoi != "left" & aoi != "right" & aoi != "facechest" & aoi != "face" & aoi != "chest") %>%
  group_by(maingroup,participant,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(!is.na(aoi)) %>%
  mutate(aoi = factor(aoi,levels=c("belly","lowerchest","midchest",
                                   "upperchest","chin","mouth","eyes","forehead")))

eyegaze_heat_all <- data %>%
  ungroup() %>%
  filter(aoi != "left" & aoi != "right" & aoi != "facechest" & aoi != "face" & aoi != "chest") %>%
  group_by(maingroup,participant,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,direction,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  group_by(maingroup,aoi) %>%
  dplyr::summarize(percent = mean(percent, na.rm=TRUE)) %>%
  ungroup() %>%
  filter(!is.na(aoi)) %>%
  mutate(aoi = factor(aoi,levels=c("belly","lowerchest","midchest",
                                   "upperchest","chin","mouth","eyes","forehead")))


ggplot(eyegaze_heat, aes(x = maingroup, y = aoi)) +
  geom_tile(aes(fill=percent),color="lightgray",na.rm=TRUE) + 
#  scale_fill_gradient(low = "lightblue",high = "steelblue") +
#  scale_fill_distiller(type="div", palette = "RdYlBu") +
  scale_fill_viridis(option = "viridis", direction=-1) +
  theme(axis.text.x=element_text(angle=45,hjust=1)) + facet_grid(. ~ direction) +
  ylab("") + xlab("") + ggtitle("Eye Gaze Heat Map, by Direction")

ggplot(eyegaze_heat_all, aes(x = maingroup, y = aoi)) +
  geom_tile(aes(fill=percent),color="lightgray",na.rm=TRUE) + 
#  scale_fill_gradient(low = "lightblue",high = "steelblue") +
#  scale_fill_distiller(type="div", palette = "RdYlBu") +
  scale_fill_viridis(option = "viridis", direction=-1) +
  theme(axis.text.x=element_text(angle=45,hjust=1)) +
  ylab("") + xlab("") + ggtitle("Eye Gaze Heat Map (Direction Collapsed)")
```

Let's run LMMs and ANOVAs, AOI by AOI. 

## Eyes AOI
Eyes AOI. LMM tells us there was no effect of direction or maingroup. The ANOVA tells us there was a main effect of group (p = 0.001) and that this effect was driven by significant differences between HearingLate and DeafEarly (p = 0.001), HearingLate and DeafLate (p = 0.014), and HearingLate and HearingNovice (p = 0.026). 

In other words, the ANOVA tells us HearingLate look more at the eyes overall than other groups (see collapsed heat map).
```{r}
eyedata <- eyegaze %>%
  spread(aoi,percent)

eyedata_subject <- eyedata %>%
  group_by(maingroup,participant,direction) %>%
  dplyr::summarize(eyes = mean(eyes,na.rm=TRUE),
                   mouth = mean(mouth,na.rm=TRUE),
                   chin = mean(chin,na.rm=TRUE),
                   fcr = mean(facechest,na.rm=TRUE))

eyes_lmm <- lmer(eyes ~ maingroup * direction + (1|id) + (1|story), data = eyedata)
summary(eyes_lmm)

eyes_aov <- aov(eyes ~ maingroup * direction, data = eyedata)
summary(eyes_aov)
TukeyHSD(eyes_aov,"maingroup",conf.level = 0.95)
```

## Mouth AOI
Mouth AOI. LMM tells us there was no effect of maingroup and a weak effect of reversal (p = 0.056). The ANOVA tells us there is a main effect of group (p < 0.001) and of direction (0.022), no interactions. 

The posthoc tells us HearingLate was different from DeafEarly (p = 0.02) and from DeafLate (0.000), and that HearingNovice was different from DeafLate (p = 0.01). 

Look at the collapsed heat map. HearingLate looked *less* at the mouth than any of the deaf. HearingNovice looked *less* than DeafLate. Really, DeafLate looks at the mouth **a lot** compared to any other group. 

```{r}
mouth_lmm <- lmer(mouth ~ maingroup * direction + (1|id) + (1|story), data = eyedata)
summary(mouth_lmm)

mouth_aov <- aov(mouth ~ maingroup * direction, data = eyedata)
summary(mouth_aov)
TukeyHSD(mouth_aov,"maingroup",conf.level = 0.95)
```

## Chin AOI
Chin AOI. LMM tells us there was no effect of maingroup and a weak effect of reversal (p = 0.050). The ANOVA tells us there is a main effect of group (p < 0.028) and a very weak one of direction (0.056), no interactions. 

The posthoc tells us DeafEarly and DeafLate were significantly different (p = 0.026) - the heat map (collapsed) tells us DeafLate looks less at the chin. 

```{r}
chin_lmm <- lmer(chin ~ maingroup * direction + (1|id) + (1|story), data = eyedata)
summary(chin_lmm)

chin_aov <- aov(chin ~ maingroup * direction, data = eyedata)
summary(chin_aov)
TukeyHSD(chin_aov,"maingroup",conf.level = 0.95)
```

## FaceChest Ratio
FCR. LMM tells us there was no effects of maingroup or reversals. There is a significant interaction for HearingNovice in the Reversed condition (p = 0.002) where they do worse, and non-significant interactinos of HearingLate and Reversed (p = 0.099) as well as HearingNovice overall (p = 0.055)

The ANOVA tells us there is a main effect of group (p < 0.001) and of direction (0.0279) with no interactions. The posthoc 

The posthoc tells us HearingNovice was different from the other three groups (p < 0.001) - their FCR was significantly lower. 

DeafLate-DeafEarly        -0.01183343 -0.08461189  0.06094503 0.9747434
HearingLate-DeafEarly     -0.03550413 -0.10459700  0.03358874 0.5436463
HearingNovice-DeafEarly   -0.14438626 -0.21394441 -0.07482811 0.0000013
HearingLate-DeafLate      -0.02367070 -0.10240989  0.05506849 0.8637293
HearingNovice-DeafLate    -0.13255283 -0.21170061 -0.05340505 0.0001358
HearingNovice-HearingLate -0.10888213 -0.18465476 -0.03310950 0.0014665

```{r}
fcr_lmm <- lmer(facechest ~ maingroup * direction + (1|id) + (1|story), data = eyedata)
summary(fcr_lmm)

fcr_aov <- aov(facechest ~ maingroup * direction, data = eyedata)
summary(fcr_aov)
TukeyHSD(fcr_aov,"maingroup",conf.level = 0.95)
```

# Summary

1. **Lexical Recall.** There is a strong effect of direction across all groups. Only HearingNovice performed significantly different than other groups. 
1. **Eye Gaze & Reversal.** Eye gaze does not appear to be strongly affected by reversal. Any effects found were weak (p = 0.05 or greater). 
1. **Eye Gaze & Group.** HearingLate looks at the eyes a lot. DeafLate looks at the mouth a lot. The FaceChest Ratio tells us novice hearing signers direct attention to the chest significantly than other groups. 
